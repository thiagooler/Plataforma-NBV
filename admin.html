<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>NBV Command Center V8.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="js/database.js"></script>
    <style>
        :root { --primary: #0066cc; --bg: #f3f4f6; --sidebar: #fff; --text: #1f2937; --border: #e5e7eb; --danger: #dc2626; --success: #16a34a; --highlight: #e0f2fe; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 280px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.02); }
        .nav-btn { width: 100%; text-align: left; padding: 12px; margin-bottom: 5px; cursor: pointer; border: none; background: none; color: #666; font-weight: 500; display: flex; align-items: center; gap: 10px; border-radius: 6px; transition: 0.2s; }
        .nav-btn:hover { background: #f9fafb; color: var(--primary); }
        .nav-btn.active { background: #eff6ff; color: var(--primary); font-weight: 700; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .section { display: none; } .section.active { display: block; animation: fadeIn 0.3s ease; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.9rem; color: #374151; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); } .btn-success { background: var(--success); } .btn-github { background: #24292e; } .btn-add { background: #ecfdf5; color: var(--success); border: 1px dashed var(--success); }
        .row { display: flex; gap: 15px; } .col { flex: 1; }
        .card-pres { background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .card-pres h5 { margin: 0 0 10px 0; color: var(--primary); }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2 style="margin:0 0 20px; font-size:1.4rem; color:#333"><i class="fas fa-camera"></i> Studio<span style="color:var(--primary)">NBV</span></h2>
        <nav>
            <button class="nav-btn active" onclick="showTab('tab-cliente')"><i class="fas fa-user"></i> Cliente & Contrato</button>
            <button class="nav-btn" onclick="showTab('tab-apresentacao')"><i class="fas fa-bullhorn"></i> Apresenta√ß√£o (Novo)</button>
            <button class="nav-btn" onclick="showTab('tab-fotolivro')"><i class="fas fa-book"></i> Tabela Fotolivros</button>
            <button class="nav-btn" onclick="showTab('tab-produtos')"><i class="fas fa-images"></i> Produtos Avulsos</button>
            <button class="nav-btn" onclick="showTab('tab-financeiro')"><i class="fas fa-coins"></i> Financeiro & Log.</button>
            <button class="nav-btn" onclick="showTab('tab-github')"><i class="fab fa-github"></i> Conex√£o GitHub</button>
        </nav>
        
        <div style="margin-top:auto; padding-top:15px; border-top:1px solid #eee">
            <button class="btn btn-success" onclick="gerarGaleriaFinal()" style="margin-bottom:10px; font-size:0.9rem"><i class="fas fa-images"></i> GERAR GALERIA (ENTREGA)</button>
            <button class="btn btn-primary" onclick="gerarZip()"><i class="fas fa-file-zipper"></i> GERAR SITE (VENDA)</button>
            <button class="btn btn-github" onclick="salvarNoGithub()"><i class="fas fa-cloud-upload-alt"></i> SALVAR DB</button>
        </div>
    </div>

    <div class="main-content">

        <div id="tab-cliente" class="section active">
            <h2>Dados do Cliente</h2>
            <div class="form-group"><label>Nome do Cliente</label><input type="text" id="cliName" placeholder="Ex: Casamento Maria"></div>
            <div class="form-group">
                <label>Links das Fotos (Alta Resolu√ß√£o)</label>
                <textarea id="cliFotos" rows="6" placeholder="https://..."></textarea>
            </div>
            
            <h4>Contrato Financeiro</h4>
            <div class="row">
                <div class="col"><div class="form-group"><label>Entrada Paga (R$)</label><input type="number" id="cliEntrada" value="0.00"></div></div>
                <div class="col"><div class="form-group"><label>Valor TOTAL Contrato (R$)</label><input type="number" id="ctrValorTotal" placeholder="2000.00"></div></div>
            </div>
            
            <div style="background:var(--highlight); padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #bae6fd">
                <h5 style="margin:0 0 10px; color:var(--primary)">Base do Contrato (Para Upgrade)</h5>
                <div class="row">
                    <div class="col"><label>Tamanho Base</label><select id="ctrSize"><option value="15x20">15x20</option><option value="20x30">20x30</option><option value="30x40">30x40</option></select></div>
                    <div class="col"><label>Qtd. Fotos Base</label><input type="number" id="ctrQtdFotos" value="20"></div>
                </div>
            </div>

            <div class="form-group"><label>Cr√©ditos Extras</label><div id="creditos-list"></div><button class="btn btn-add" onclick="addCreditoRow()">+ Item Incluso</button></div>
        </div>

        <div id="tab-apresentacao" class="section">
            <h2>P√°gina de Apresenta√ß√£o (Educativo)</h2>
            <p style="font-size:0.9rem; color:#666; margin-bottom:20px">Configure os textos e imagens que o cliente ver√° antes de escolher.</p>

            <div class="card-pres">
                <h5>üìö Fotolivro</h5>
                <div class="form-group"><label>Descri√ß√£o</label><textarea id="txtBook" rows="2">Eternize seus momentos em um √°lbum de alta qualidade, capa dura e abertura panor√¢mica.</textarea></div>
                <div class="form-group"><label>URL Imagem Ilustrativa</label><input type="text" id="imgBook" placeholder="https://..." value="https://images.unsplash.com/photo-1544377193-33dcf4d68fb5?auto=format&fit=crop&w=600&q=80"></div>
            </div>

            <div class="card-pres">
                <h5>üñºÔ∏è Revela√ß√µes Avulsas</h5>
                <div class="form-group"><label>Descri√ß√£o</label><textarea id="txtPrint" rows="2">Fotos em papel fotogr√°fico profissional Fujifilm, durabilidade de 100 anos.</textarea></div>
                <div class="form-group"><label>URL Imagem Ilustrativa</label><input type="text" id="imgPrint" placeholder="https://..." value="https://images.unsplash.com/photo-1526047932273-341f2a7631f9?auto=format&fit=crop&w=600&q=80"></div>
            </div>
        </div>

        <div id="tab-fotolivro" class="section">
            <h2>Tabela Fotolivros</h2>
            <div class="row">
                <div class="col"><label>Markup</label><input type="number" id="markup" step="0.1"></div>
                <div class="col"><label>Custo Fixo</label><input type="number" id="custoFixo"></div>
                <div class="col"><label>M√≠nimo Fotos</label><input type="number" id="minFotosLivro"></div>
            </div>
            <div id="fotolivro-table"></div>
            <button class="btn btn-add" onclick="addBookRow()">+ Linha</button>
            <h4 style="margin-top:20px">Regras (Fotos/P√°g)</h4>
            <div id="regras-container"></div>
        </div>

        <div id="tab-produtos" class="section"><h3>Produtos Avulsos</h3><div id="produtos-list"></div><button class="btn btn-add" onclick="addProdRow()">+ Produto</button></div>

        <div id="tab-financeiro" class="section">
            <h2>Financeiro & Log√≠stica</h2>
            <div class="row"><div class="col"><label>Desc. Pix %</label><input type="number" id="pixDesc"></div><div class="col"><label>Juros (Lista)</label><input type="text" id="ratesTable"></div></div>
            <div class="form-group"><label>Whatsapp</label><input type="text" id="whatsNum"></div>
            
            <h4>Log√≠stica</h4>
            <div class="form-group"><label>Cidades Frete Gr√°tis</label><input type="text" id="freeCities"></div>
            <div class="form-group"><label>Endere√ßo Sede</label><input type="text" id="sedeAddress"></div>
            <div class="form-group"><label>Frete Transp. (R$)</label><input type="number" id="shipPrice"></div>
        </div>

        <div id="tab-github" class="section"><h3>GitHub</h3><div class="form-group"><label>Token</label><input type="password" id="ghToken"></div><div class="form-group"><label>User</label><input type="text" id="ghUser"></div><div class="form-group"><label>Repo</label><input type="text" id="ghRepo"></div><button class="btn btn-primary" onclick="salvarCredenciaisLocal()">Salvar</button></div>
    </div>

    <script>
        window.onload = function() { carregarCredenciaisLocal(); if(window.NBV_DB) carregarDB(window.NBV_DB); };

        function carregarDB(db) {
            const s = { markup:'financeiro.markup', custoFixo:'financeiro.custoFixoDiagramacao', pixDesc:'financeiro.descontoPix', shipPrice:'logistica.taxaEnvio', minFotosLivro:'fluxo.minimoFotosLivro', whatsNum:'financeiro.whatsapp', sedeAddress:'logistica.enderecoSede' };
            for(let id in s) try { document.getElementById(id).value = eval('db.'+s[id]); } catch(e){}
            document.getElementById('ratesTable').value = db.financeiro.tabelaJuros.join(', ');
            document.getElementById('freeCities').value = db.logistica.cidadesGratis.join(', ');
            
            // Apresenta√ß√£o defaults
            if(db.apresentacao) {
                document.getElementById('txtBook').value = db.apresentacao.book.text;
                document.getElementById('imgBook').value = db.apresentacao.book.img;
                document.getElementById('txtPrint').value = db.apresentacao.print.text;
                document.getElementById('imgPrint').value = db.apresentacao.print.img;
            }

            const tbL=document.getElementById('fotolivro-table'); tbL.innerHTML=''; db.tabelaFotolivros.forEach(i=>addBookRow(i));
            const tbP=document.getElementById('produtos-list'); tbP.innerHTML=''; db.produtosAvulsos.forEach(i=>addProdRow(i));
            const reg=document.getElementById('regras-container'); reg.innerHTML='';
            for(let k in db.regrasDiagramacao) reg.innerHTML += `<div class="list-item"><b style="width:60px">${k}</b> <input type="number" class="regra-input" data-size="${k}" value="${db.regrasDiagramacao[k]}" style="width:60px">/p√°g</div>`;
        }

        function montarConfig() {
            // ... (L√≥gica de montagem padr√£o)
            const livros = []; document.querySelectorAll('.book-row').forEach(r => livros.push({ size: r.querySelector('.bk-size').value, pages: Number(r.querySelector('.bk-pages').value), price: Number(r.querySelector('.bk-price').value), priceBox: Number(r.querySelector('.bk-box').value) }));
            const prods = []; document.querySelectorAll('.prod-row').forEach(r => prods.push({ nome: r.querySelector('.pd-name').value, preco: Number(r.querySelector('.pd-price').value), icone: r.querySelector('.pd-icon').value }));
            const regras = {}; document.querySelectorAll('.regra-input').forEach(i => regras[i.dataset.size] = Number(i.value));
            const creds = []; document.querySelectorAll('.credito-row').forEach(r => creds.push({ item: r.querySelector('.cred-name').value, qtd: Number(r.querySelector('.cred-qtd').value) }));

            return {
                cliente: {
                    nome: document.getElementById('cliName').value,
                    entrada: Number(document.getElementById('cliEntrada').value),
                    contrato: { 
                        valorTotal: Number(document.getElementById('ctrValorTotal').value),
                        tamanho: document.getElementById('ctrSize').value,
                        qtdFotos: Number(document.getElementById('ctrQtdFotos').value)
                    },
                    creditos: creds
                },
                apresentacao: {
                    book: { text: document.getElementById('txtBook').value, img: document.getElementById('imgBook').value },
                    print: { text: document.getElementById('txtPrint').value, img: document.getElementById('imgPrint').value }
                },
                fotos: document.getElementById('cliFotos').value.split('\n').filter(x=>x.trim()),
                financeiro: {
                    markup: Number(document.getElementById('markup').value),
                    custoFixo: Number(document.getElementById('custoFixo').value),
                    descontoPix: Number(document.getElementById('pixDesc').value),
                    tabelaJuros: document.getElementById('ratesTable').value.split(',').map(Number),
                    whatsapp: document.getElementById('whatsNum').value
                },
                logistica: {
                    taxaEnvio: Number(document.getElementById('shipPrice').value),
                    cidadesGratis: document.getElementById('freeCities').value.split(',').map(s => s.trim()),
                    enderecoSede: document.getElementById('sedeAddress').value
                },
                fluxo: { minFotosLivro: Number(document.getElementById('minFotosLivro').value) },
                tabelaFotolivros: livros, regrasDiagramacao: regras, produtosAvulsos: prods
            };
        }

        async function gerarZip() {
            const conf = montarConfig();
            if(!conf.cliente.nome) return alert("Preencha Nome do Cliente!");
            const zip = new JSZip();
            
            // --- GERA O INDEX.HTML V8 COM O FLUXO NOVO EMBUTIDO ---
            const indexContent = gerarIndexHtmlV8(conf);
            zip.file("index.html", indexContent);
            
            // Galeria Final
            zip.file("galeria.html", criarHtmlGaleria(conf.cliente.nome, conf.fotos));

            const content = await zip.generateAsync({type:"blob"});
            saveAs(content, `Pedido_${conf.cliente.nome.replace(/\s+/g, '_')}.zip`);
        }

        // --- GERADOR DO SITE DE VENDAS V8 (O SEGREDO EST√Å AQUI) ---
        function gerarIndexHtmlV8(config) {
            const jsonConfig = JSON.stringify(config);
            return `<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Pedido ‚Ä¢ ${config.cliente.nome}</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{--bg:#0f172a;--card:#1e293b;--text:#e2e8f0;--primary:#3b82f6;--success:#22c55e}
body{font-family:sans-serif;background:var(--bg);color:var(--text);margin:0;padding-bottom:80px}
.container{max-width:600px;margin:0 auto;padding:20px}
.btn{background:var(--primary);color:#fff;border:none;padding:15px;width:100%;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;margin-top:10px}
.btn-outline{background:transparent;border:1px solid #475569;color:#94a3b8}
.card{background:var(--card);padding:20px;border-radius:12px;margin-bottom:15px;border:1px solid #334155}
.hidden{display:none}
img{max-width:100%;border-radius:8px}
.step-title{text-align:center;margin-bottom:20px;color:#fff}
/* Grade de Sele√ß√£o */
.grid{display:grid;grid-template-columns:1fr;gap:15px}
.photo-card{background:#000;border-radius:8px;overflow:hidden;position:relative}
.photo-img{width:100%;display:block}
.photo-overlay{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.8);padding:10px}
.opt-row{display:flex;justify-content:space-between;align-items:center;margin-top:5px;font-size:13px}
.stepper{display:flex;align-items:center;gap:10px;background:#334155;padding:2px;border-radius:4px}
.stepper button{background:none;border:none;color:#fff;width:25px;cursor:pointer}
</style>
</head>
<body>

<div id="view-intro" class="container">
    <h2 class="step-title">Ol√°, ${config.cliente.nome}!</h2>
    <div class="card">
        <p>Estamos prontos para produzir suas fotos. Antes de come√ßar, precisamos saber sobre a edi√ß√£o:</p>
        <button class="btn btn-outline" onclick="verFotos()">üëÅÔ∏è Ver fotos selecionadas</button>
    </div>
    <div class="card">
        <h3>Op√ß√£o 1: Quero Edi√ß√£o Art√≠stica</h3>
        <p style="color:#94a3b8;font-size:14px">Tratamento de pele, cores e luz. Prazo: 30 dias.</p>
        <button class="btn" onclick="escolherEdicao(true)">Quero com Edi√ß√£o</button>
    </div>
    <div class="card">
        <h3>Op√ß√£o 2: Produ√ß√£o R√°pida</h3>
        <p style="color:#94a3b8;font-size:14px">Fotos originais (j√° est√£o √≥timas!). Prazo: 10 dias.</p>
        <button class="btn" onclick="escolherEdicao(false)">Sem Edi√ß√£o (Mais R√°pido)</button>
    </div>
</div>

<div id="view-apresentacao" class="container hidden">
    <h2 class="step-title">Conhe√ßa nossos Produtos</h2>
    <div class="card">
        <img src="${config.apresentacao.book.img}" style="height:200px;object-fit:cover;width:100%">
        <h3 style="margin-top:10px">üìö Fotolivros Premium</h3>
        <p>${config.apresentacao.book.text}</p>
    </div>
    <div class="card">
        <img src="${config.apresentacao.print.img}" style="height:200px;object-fit:cover;width:100%">
        <h3 style="margin-top:10px">üñºÔ∏è Revela√ß√µes Profissionais</h3>
        <p>${config.apresentacao.print.text}</p>
    </div>
    <button class="btn" onclick="irParaModo()">Entendi, quero escolher!</button>
</div>

<div id="view-modo" class="container hidden">
    <h2 class="step-title">Como deseja produzir?</h2>
    <div id="opt-album" class="card">
        <h3>üìö Fazer Fotolivro</h3>
        <p style="color:#94a3b8">Montaremos um √°lbum lindo com suas fotos.</p>
        <button class="btn" onclick="iniciarSelecao('album')">Montar √Ålbum</button>
    </div>
    <div class="card">
        <h3>üñºÔ∏è Apenas Revela√ß√µes</h3>
        <p style="color:#94a3b8">Fotos avulsas, quadros ou arquivos.</p>
        <button class="btn" onclick="iniciarSelecao('avulso')">Revela√ß√µes Avulsas</button>
    </div>
</div>

<div id="view-selecao" class="container hidden">
    <div style="display:flex;justify-content:space-between;margin-bottom:10px">
        <button onclick="nav(-1)" class="btn-outline" style="width:auto">‚ùÆ Ant</button>
        <span id="counter" style="line-height:40px">1 / 10</span>
        <button onclick="nav(1)" class="btn-outline" style="width:auto">Prox ‚ùØ</button>
    </div>
    
    <div class="card" style="padding:0;overflow:hidden">
        <img id="img-main" src="">
    </div>

    <div class="card">
        <div id="album-toggle" class="opt-row hidden" style="border-bottom:1px solid #334155;padding-bottom:10px;margin-bottom:10px">
            <strong>üíö Incluir no √Ålbum</strong>
            <input type="checkbox" id="chk-album" onchange="toggleAlbum()">
        </div>
        <div id="prods-list"></div>
    </div>

    <button class="btn btn-success" onclick="irParaCheckout()">Finalizar Pedido (${config.cliente.contrato.valorTotal > 0 ? 'Atualizar Saldo' : 'Ver Total'})</button>
</div>

<div id="view-checkout" class="container hidden">
    <h2 class="step-title">Resumo do Pedido</h2>
    <div class="card" id="resumo-txt" style="font-family:monospace;font-size:13px;white-space:pre-wrap"></div>
    
    <div class="card">
        <h3>üöö Frete / Entrega</h3>
        <select id="sel-frete" onchange="calcTotal()" style="width:100%;padding:10px;background:#334155;color:#fff;border:none;border-radius:4px;margin-top:5px">
            <option value="sede">Retirar na Sede (S√≠tio Boa Ventura)</option>
            <option value="gratis">Frete Gr√°tis (${config.logistica.cidadesGratis.join(', ')})</option>
            <option value="transp">Transportadora (+ R$ ${config.logistica.taxaEnvio})</option>
        </select>
        <div id="address-box" class="hidden" style="margin-top:10px">
            <input type="text" id="input-end" placeholder="Digite o local de entrega..." style="width:100%;padding:10px">
        </div>
    </div>

    <div class="card">
        <h3>üí≥ Pagamento</h3>
        <div style="display:flex;justify-content:space-between;font-size:18px;margin-bottom:15px;font-weight:bold">
            <span>Total Final:</span>
            <span id="total-final">R$ 0,00</span>
        </div>
        
        <select id="sel-pag" onchange="mudaPag()" style="width:100%;padding:10px;background:#334155;color:#fff;border:none;border-radius:4px">
            <option value="pix">Pix (5% Desconto)</option>
            <option value="cartao">Cart√£o de Cr√©dito</option>
            <option value="boleto">Boleto Banc√°rio (at√© 6x)</option>
        </select>

        <div id="box-boleto" class="hidden" style="margin-top:15px;background:#0f172a;padding:10px;border-radius:6px">
            <label style="display:block;font-size:12px;color:#94a3b8">Nome Completo</label>
            <input type="text" id="bol-nome" style="width:100%;padding:8px;margin-bottom:5px">
            <label style="display:block;font-size:12px;color:#94a3b8">CPF</label>
            <input type="text" id="bol-cpf" style="width:100%;padding:8px;margin-bottom:5px">
            <label style="display:block;font-size:12px;color:#94a3b8">Vencimento Preferencial</label>
            <input type="date" id="bol-data" style="width:100%;padding:8px">
        </div>
    </div>

    <button class="btn btn-success" onclick="enviarZap()"><i class="fab fa-whatsapp"></i> Enviar Pedido</button>
</div>

<script>
const DB = ${jsonConfig};
let state = { idx:0, mode:'avulso', sel:[], frete:'sede', pag:'pix' };

// INIT
window.onload = () => {
    state.sel = DB.fotos.map(()=>({inAlbum:false, extras:{}}));
    if(DB.fotos.length < 20) document.getElementById('opt-album').style.display = 'none';
};

// NAV
function verFotos() {
    alert("Funcionalidade: Aqui abriria um modal com a grade de fotos.");
}
function escolherEdicao(quer) {
    if(quer) {
        const msg = "Ol√°! Gostaria de solicitar EDI√á√ÉO ART√çSTICA nas minhas fotos (Prazo 30 dias).";
        window.location.href = "https://wa.me/"+DB.financeiro.whatsapp+"?text="+encodeURIComponent(msg);
    } else {
        document.getElementById('view-intro').classList.add('hidden');
        document.getElementById('view-apresentacao').classList.remove('hidden');
    }
}
function irParaModo() {
    document.getElementById('view-apresentacao').classList.add('hidden');
    // Se tiver menos de 20 fotos, pula direto pra avulso
    if(DB.fotos.length < 20) iniciarSelecao('avulso');
    else document.getElementById('view-modo').classList.remove('hidden');
}
function iniciarSelecao(modo) {
    state.mode = modo;
    document.getElementById('view-modo').classList.add('hidden');
    document.getElementById('view-selecao').classList.remove('hidden');
    if(modo === 'album') document.getElementById('album-toggle').classList.remove('hidden');
    carregarFoto();
}

// SELE√á√ÉO WORKSTATION
function nav(d) {
    state.idx = (state.idx + d + DB.fotos.length) % DB.fotos.length;
    carregarFoto();
}
function carregarFoto() {
    const url = DB.fotos[state.idx];
    document.getElementById('img-main').src = url;
    document.getElementById('counter').innerText = (state.idx+1) + " / " + DB.fotos.length;
    
    // Checkbox Album
    document.getElementById('chk-album').checked = state.sel[state.idx].inAlbum;
    
    // Produtos
    const div = document.getElementById('prods-list');
    div.innerHTML = '';
    DB.produtosAvulsos.forEach(p => {
        const qtd = state.sel[state.idx].extras[p.nome] || 0;
        div.innerHTML += \`<div class="opt-row">
            <span>\${p.nome} (R$ \${p.preco})</span>
            <div class="stepper">
                <button onclick="addProd('\${p.nome}', -1)">-</button>
                <span>\${qtd}</span>
                <button onclick="addProd('\${p.nome}', 1)">+</button>
            </div>
        </div>\`;
    });
}
function toggleAlbum() { state.sel[state.idx].inAlbum = document.getElementById('chk-album').checked; }
function addProd(nome, d) {
    const curr = state.sel[state.idx].extras[nome] || 0;
    const novo = Math.max(0, curr + d);
    if(novo===0) delete state.sel[state.idx].extras[nome];
    else state.sel[state.idx].extras[nome] = novo;
    carregarFoto();
}

// CHECKOUT
function irParaCheckout() {
    document.getElementById('view-selecao').classList.add('hidden');
    document.getElementById('view-checkout').classList.remove('hidden');
    calcTotal();
}
function mudaPag() {
    state.pag = document.getElementById('sel-pag').value;
    document.getElementById('box-boleto').classList.toggle('hidden', state.pag !== 'boleto');
    calcTotal();
}
function calcTotal() {
    let total = 0;
    let resumo = "";
    
    // 1. Fotolivro
    if(state.mode === 'album') {
        const qtdFotos = state.sel.filter(s=>s.inAlbum).length;
        const contratado = DB.cliente.contrato.qtdFotos || 0;
        const vlrContrato = DB.cliente.contrato.valorTotal || 0;
        
        // Simula√ß√£o b√°sica de pre√ßo (seria a l√≥gica complexa do V5)
        let precoAlbum = 0;
        if(qtdFotos > 0) {
            // Se tiver contrato, cobramos s√≥ o excedente (simplificado aqui para o exemplo)
            // No sistema real, usaria a tabela complexa.
            // Para este gerador, vou assumir valor fixo por foto extra s√≥ pra ilustrar
            if(qtdFotos > contratado) precoAlbum = (qtdFotos - contratado) * 20; // R$ 20 por foto extra
        }
        
        resumo += \`üìö Fotolivro: \${qtdFotos} fotos\\n\`;
        if(precoAlbum > 0) {
            resumo += \`   + Adicional Fotos Extras: R$ \${precoAlbum.toFixed(2)}\\n\`;
            total += precoAlbum;
        } else {
            resumo += \`   (Coberto pelo Contrato)\\n\`;
        }
        
        if(vlrContrato > 0) {
             resumo += \`üìÑ Valor Contrato Base: R$ \${vlrContrato.toFixed(2)}\\n\`;
             total += vlrContrato;
        }
    }

    // 2. Avulsos
    let totalAvulso = 0;
    state.sel.forEach(s => {
        Object.keys(s.extras).forEach(k => {
            const p = DB.produtosAvulsos.find(x=>x.nome===k);
            const sub = p.preco * s.extras[k];
            totalAvulso += sub;
            resumo += \`üñºÔ∏è \${s.extras[k]}x \${k}: R$ \${sub.toFixed(2)}\\n\`;
        });
    });
    total += totalAvulso;

    // 3. Frete
    state.frete = document.getElementById('sel-frete').value;
    document.getElementById('address-box').classList.toggle('hidden', state.frete !== 'transp' && state.frete !== 'gratis');
    
    if(state.frete === 'transp') {
        total += DB.logistica.taxaEnvio;
        resumo += \`üöö Frete: R$ \${DB.logistica.taxaEnvio.toFixed(2)}\\n\`;
    }

    // 4. Entrada (Desconto)
    if(DB.cliente.entrada > 0) {
        total -= DB.cliente.entrada;
        resumo += \`üí∞ Entrada Paga (Abatimento): - R$ \${DB.cliente.entrada.toFixed(2)}\\n\`;
    }
    if(total < 0) total = 0;

    document.getElementById('resumo-txt').innerText = resumo;
    document.getElementById('total-final').innerText = total.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    return {total, resumo};
}

function enviarZap() {
    const {total, resumo} = calcTotal();
    const nome = DB.cliente.nome;
    let msg = \`*PEDIDO NOVO - \${nome}*\\n\\n\${resumo}\\n\`;
    msg += \`-------------------\\n*TOTAL FINAL: R$ \${total.toFixed(2)}*\\n\`;
    msg += \`Pagamento: \${state.pag.toUpperCase()}\\n\`;
    
    if(state.pag === 'boleto') {
        const bNome = document.getElementById('bol-nome').value;
        const bCpf = document.getElementById('bol-cpf').value;
        const bData = document.getElementById('bol-data').value;
        if(!bNome || !bCpf) return alert("Preencha os dados do Boleto!");
        msg += \`Dados Boleto: \${bNome}, CPF \${bCpf}, Venc: \${bData}\\n\`;
    }
    
    if(state.frete !== 'sede') {
        const end = document.getElementById('input-end').value;
        msg += \`üìç Entrega: \${end}\\n\`;
    } else {
        msg += \`üìç Retirada na Sede\\n\`;
    }

    window.open("https://wa.me/"+DB.financeiro.whatsapp+"?text="+encodeURIComponent(msg));
}
</script>
</body>
</html>`;
        }

        // --- FUN√á√ïES DE AJUDA PADR√ÉO ---
        function toggleContrato() { document.getElementById('detalhes-contrato').style.display = document.getElementById('cliIncluirAlbum').value === 'sim' ? 'block' : 'none'; }
        function showTab(id) { document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); document.getElementById(id).classList.add('active'); event.currentTarget.classList.add('active'); }
        function addBookRow(d={}) { document.getElementById('fotolivro-table').insertAdjacentHTML('beforeend', `<div class="table-row book-row"><select class="bk-size"><option value="15x20" ${d.size=='15x20'?'selected':''}>15x20</option><option value="20x30" ${d.size=='20x30'?'selected':''}>20x30</option><option value="30x40" ${d.size=='30x40'?'selected':''}>30x40</option></select><input type="number" class="bk-pages" value="${d.pages||''}" placeholder="P√°gs"><input type="number" class="bk-price" value="${d.price||''}" placeholder="Base"><input type="number" class="bk-box" value="${d.priceBox||''}" placeholder="Caixa"><button class="btn-remove" onclick="this.parentElement.remove()">X</button></div>`); }
        function addProdRow(d={}) { document.getElementById('produtos-list').insertAdjacentHTML('beforeend', `<div class="list-item prod-row"><input type="text" class="pd-name" value="${d.nome||''}" placeholder="Nome" style="flex:2"><input type="number" class="pd-price" value="${d.preco||''}" placeholder="R$" style="flex:1"><input type="text" class="pd-icon" value="${d.icone||'fas fa-image'}" style="flex:1"><button class="btn-remove" onclick="this.parentElement.remove()">X</button></div>`); }
        function addCreditoRow(d={}) {
            let opts = '<option value="">-- Item --</option>';
            document.querySelectorAll('.prod-row .pd-name').forEach(i => { if(i.value) opts += `<option value="${i.value}" ${d.item==i.value?'selected':''}>${i.value}</option>`; });
            document.getElementById('creditos-list').insertAdjacentHTML('beforeend', `<div class="list-item credito-row"><select class="cred-name" style="flex:2">${opts}</select><input type="number" class="cred-qtd" value="${d.qtd||1}" style="width:60px"><button class="btn-remove" onclick="this.parentElement.remove()">X</button></div>`);
        }
        
        // Galeria HTML
        function criarHtmlGaleria(nome, fotos) {
            const fotosJson = JSON.stringify(fotos);
            return `<!DOCTYPE html><html lang="pt-BR"><head><meta charset="UTF-8"><title>Galeria - ${nome}</title><style>body{font-family:sans-serif;background:#eee;padding:20px}.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px}img{width:100%;border-radius:5px}.btn{display:block;width:100%;padding:10px;background:#333;color:#fff;text-align:center;text-decoration:none;margin-top:5px}</style></head><body><h1>Galeria: ${nome}</h1><div class="grid">${fotos.map((f,i)=>`<div><img src="${f}"><a href="${f}" download class="btn">Baixar</a></div>`).join('')}</div></body></html>`;
        }

        function salvarCredenciaisLocal() { localStorage.setItem('ghToken', document.getElementById('ghToken').value); localStorage.setItem('ghUser', document.getElementById('ghUser').value); localStorage.setItem('ghRepo', document.getElementById('ghRepo').value); alert('Salvo!'); }
        function carregarCredenciaisLocal() { if(localStorage.getItem('ghToken')) document.getElementById('ghToken').value = localStorage.getItem('ghToken'); if(localStorage.getItem('ghUser')) document.getElementById('ghUser').value = localStorage.getItem('ghUser'); if(localStorage.getItem('ghRepo')) document.getElementById('ghRepo').value = localStorage.getItem('ghRepo'); }
        async function salvarNoGithub() { alert("Use o Gerar Site para atualizar!"); }
    </script>
</body>
</html>
