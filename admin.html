<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>NBV Admin - Cloud Connected V12</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root { --primary: #0066cc; --bg: #f3f4f6; --sidebar: #fff; --text: #1f2937; --border: #e5e7eb; --success: #16a34a; --danger: #dc2626; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 280px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        
        /* STATUS BAR */
        .status-bar { padding: 10px; border-radius: 6px; margin-bottom: 20px; text-align: center; font-size: 0.85rem; font-weight: 600; transition: 0.3s; }
        .status-disconnected { background: #fee2e2; color: var(--danger); border: 1px solid #fca5a5; }
        .status-connected { background: #dcfce7; color: var(--success); border: 1px solid #86efac; }
        .status-loading { background: #e0f2fe; color: var(--primary); border: 1px solid #bae6fd; }

        /* NAV */
        .nav-btn { width: 100%; text-align: left; padding: 12px; margin-bottom: 5px; cursor: pointer; border: none; background: none; color: #666; font-weight: 600; display: flex; align-items: center; gap: 10px; border-radius: 6px; transition: 0.2s; }
        .nav-btn:hover, .nav-btn.active { background: #eff6ff; color: var(--primary); }
        
        /* FORMS */
        .section { display: none; } .section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }
        
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; margin-top: 5px; }
        label { font-weight: 600; font-size: 0.9rem; color: #374151; }
        .form-group { margin-bottom: 15px; }
        .row { display: flex; gap: 15px; } .col { flex: 1; }

        /* BUTTONS */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary); } 
        .btn-github { background: #24292e; }
        .btn-add { background: #ecfdf5; color: #16a34a; border: 1px dashed #16a34a; }
        .btn-remove { background: #fee2e2; color: #dc2626; border: none; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; }

        /* LISTS */
        .list-item { background: #fff; padding: 10px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 5px; display:flex; align-items:center; gap:10px; }
        .credito-box { border: 1px dashed var(--primary); padding: 15px; border-radius: 8px; background: #f0f9ff; margin-top: 15px; }
        
        /* OVERLAY LOADING */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 1000; display: none; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <i class="fas fa-spinner fa-spin" style="font-size: 40px; color: var(--primary)"></i>
        <p id="loading-text" style="margin-top: 15px; font-weight: 600; color: #555">Conectando ao GitHub...</p>
    </div>

    <div class="sidebar">
        <h2 style="margin:0 0 20px; font-size:1.4rem; color:#333"><i class="fas fa-camera"></i> Studio<span style="color:var(--primary)">NBV</span></h2>
        
        <div id="status-display" class="status-bar status-disconnected">
            <i class="fas fa-plug"></i> Desconectado
        </div>

        <nav>
            <button class="nav-btn" onclick="showTab('tab-github')"><i class="fab fa-github"></i> 1. Conex√£o (Obrigat√≥rio)</button>
            <button class="nav-btn" onclick="showTab('tab-financeiro')"><i class="fas fa-coins"></i> 2. Pre√ßos & Config</button>
            <button class="nav-btn" onclick="showTab('tab-apresentacao')"><i class="fas fa-bullhorn"></i> 3. Textos</button>
            <button class="nav-btn" onclick="showTab('tab-fotolivro')"><i class="fas fa-book"></i> 4. Fotolivros</button>
            <button class="nav-btn" onclick="showTab('tab-produtos')"><i class="fas fa-images"></i> 5. Avulsos</button>
            <div style="height:1px; background:#eee; margin:10px 0"></div>
            <button class="nav-btn active" onclick="showTab('tab-cliente')"><i class="fas fa-user"></i> 6. Criar Pedido</button>
        </nav>
        
        <div style="margin-top:auto; padding-top:15px; border-top:1px solid #eee">
            <button class="btn btn-primary" onclick="gerarSiteCompleto()" id="btn-gerar" disabled style="opacity:0.5; cursor:not-allowed">
                <i class="fas fa-file-zipper"></i> GERAR SITE
            </button>
            <small style="display:block; text-align:center; color:#999; margin-top:5px">Conecte para habilitar</small>
        </div>
    </div>

    <div class="main-content">

        <div id="tab-github" class="section">
            <h2>‚òÅÔ∏è Conex√£o GitHub (Banco de Dados)</h2>
            <div class="card" style="background:white; padding:20px; border-radius:8px; border:1px solid #ddd">
                <p>O sistema n√£o possui dados internos. Conecte-se para puxar a tabela de pre√ßos mais recente.</p>
                <div class="form-group">
                    <label>Token Pessoal (GitHub PAT)</label>
                    <input type="password" id="ghToken" placeholder="ghp_...">
                </div>
                <div class="row">
                    <div class="col"><label>Usu√°rio</label><input type="text" id="ghUser" placeholder="Ex: usuario"></div>
                    <div class="col"><label>Reposit√≥rio</label><input type="text" id="ghRepo" placeholder="Ex: studio-nbv"></div>
                </div>
                <div class="row" style="margin-top:20px">
                    <div class="col">
                        <button class="btn btn-primary" onclick="Github.carregar(true)">
                            <i class="fas fa-sync"></i> Conectar & Baixar Dados
                        </button>
                    </div>
                    <div class="col">
                        <button class="btn btn-github" onclick="Github.salvar()">
                            <i class="fas fa-cloud-upload-alt"></i> Salvar Altera√ß√µes na Nuvem
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-cliente" class="section active">
            <h2>Dados do Cliente</h2>
            <div class="form-group"><label>Nome</label><input type="text" id="cliName"></div>
            <div class="form-group"><label>Links Fotos (Uma URL por linha)</label><textarea id="cliFotos" rows="6"></textarea></div>
            
            <div class="mode-selector">
                <label>Objetivo:</label>
                <select id="fluxoModo">
                    <option value="venda">üí∞ Venda Completa</option>
                    <option value="aprovacao">‚úÖ Apenas Aprova√ß√£o</option>
                </select>
            </div>

            <div class="row">
                <div class="col"><label>Entrada Paga (R$)</label><input type="number" id="cliEntrada" value="0.00"></div>
                <div class="col">
                    <label>J√° tem √°lbum pago?</label>
                    <select id="cliIncluirAlbum"><option value="nao">N√£o</option><option value="sim">Sim</option></select>
                </div>
            </div>

            <div class="credito-box">
                <label style="color:var(--primary)">üéÅ Cr√©ditos / Brindes</label>
                <div id="creditos-list"></div>
                <button class="btn btn-add" style="width:auto; padding:8px" onclick="addCreditoRow()">+ Item</button>
            </div>
        </div>

        <div id="tab-financeiro" class="section">
            <h2>Configura√ß√µes Gerais</h2>
            <div class="form-group"><label>WhatsApp</label><input type="text" id="whatsNum"></div>
            <div class="form-group"><label>Taxa Entrega</label><input type="number" id="shipPrice"></div>
            <div class="form-group"><label>Cidades Gr√°tis</label><input type="text" id="freeCities"></div>
            <div class="form-group"><label>Marca D'√°gua</label><input type="text" id="wmText"></div>
        </div>

        <div id="tab-apresentacao" class="section">
            <h2>Textos</h2>
            <label>Fotolivro</label><textarea id="txtBook" rows="2"></textarea>
            <input type="text" id="imgBook" placeholder="URL Imagem">
            <hr>
            <label>Revela√ß√£o</label><textarea id="txtPrint" rows="2"></textarea>
            <input type="text" id="imgPrint" placeholder="URL Imagem">
        </div>

        <div id="tab-fotolivro" class="section">
            <h2>Tabela Fotolivro</h2>
            <div class="row">
                <div class="col"><label>Markup</label><input type="number" id="markup"></div>
                <div class="col"><label>Custo Fixo</label><input type="number" id="custoFixo"></div>
            </div>
            <div id="fotolivro-table"></div>
            <button class="btn btn-add" onclick="addBookRow()">+ Tamanho</button>
        </div>

        <div id="tab-produtos" class="section">
            <h2>Produtos Avulsos</h2>
            <div id="produtos-list"></div>
            <button class="btn btn-add" onclick="addProdRow()">+ Produto</button>
        </div>

    </div>

    <script>
        // ESTADO GLOBAL DO GITHUB
        let ghState = {
            sha: null,
            isConnected: false
        };

        window.onload = () => {
            Github.restaurarCredenciais();
            // Tenta conectar automaticamente se tiver token
            if(document.getElementById('ghToken').value) {
                Github.carregar(false); // false = sem alert de sucesso, silencioso
            } else {
                showTab('tab-github'); // For√ßa ir para conex√£o
            }
        };

        function showTab(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            // Highlight nav button
            const btns = document.querySelectorAll('.nav-btn');
            for(let b of btns) { if(b.getAttribute('onclick').includes(id)) b.classList.add('active'); }
        }

        // --- GITHUB API ENGINE ---
        const Github = {
            restaurarCredenciais: function() {
                ['ghToken','ghUser','ghRepo'].forEach(k => {
                    if(localStorage.getItem(k)) document.getElementById(k).value = localStorage.getItem(k);
                });
            },
            
            salvarCredenciais: function() {
                ['ghToken','ghUser','ghRepo'].forEach(k => {
                    localStorage.setItem(k, document.getElementById(k).value);
                });
            },

            getApiUrl: function() {
                const u = document.getElementById('ghUser').value;
                const r = document.getElementById('ghRepo').value;
                return `https://api.github.com/repos/${u}/${r}/contents/js/database.js`;
            },

            setLoading: function(active, text) {
                document.getElementById('loading-overlay').style.display = active ? 'flex' : 'none';
                if(text) document.getElementById('loading-text').innerText = text;
            },

            updateStatus: function(connected) {
                const el = document.getElementById('status-display');
                const btn = document.getElementById('btn-gerar');
                ghState.isConnected = connected;
                
                if(connected) {
                    el.className = 'status-bar status-connected';
                    el.innerHTML = '<i class="fas fa-check-circle"></i> Conectado ao GitHub';
                    btn.disabled = false;
                    btn.style.opacity = 1;
                    btn.style.cursor = 'pointer';
                } else {
                    el.className = 'status-bar status-disconnected';
                    el.innerHTML = '<i class="fas fa-plug"></i> Desconectado';
                    btn.disabled = true;
                    btn.style.opacity = 0.5;
                }
            },

            // CARREGAR (GET)
            carregar: async function(showAlert = true) {
                this.salvarCredenciais();
                const token = document.getElementById('ghToken').value;
                if(!token) { if(showAlert) alert("Preencha o Token!"); return; }

                this.setLoading(true, "Baixando dados do GitHub...");

                try {
                    const res = await fetch(this.getApiUrl(), {
                        headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
                    });

                    if(!res.ok) throw new Error(res.statusText);

                    const data = await res.json();
                    ghState.sha = data.sha; // Salva o SHA para poder fazer update depois
                    
                    const content = decodeURIComponent(escape(window.atob(data.content)));
                    const jsonStr = content.replace('window.NBV_DB = ', '').replace(/;$/, '');
                    const db = eval(`(${jsonStr})`); // Parse permissivo

                    preencherCampos(db);
                    this.updateStatus(true);
                    if(showAlert) alert("Dados carregados da nuvem com sucesso!");

                } catch(e) {
                    console.error(e);
                    this.updateStatus(false);
                    if(showAlert) alert("Erro ao conectar: " + e.message + "\nVerifique Token e Nome do Reposit√≥rio.");
                } finally {
                    this.setLoading(false);
                }
            },

            // SALVAR (PUT)
            salvar: async function() {
                if(!ghState.isConnected) { alert("Conecte-se primeiro!"); return; }
                const token = document.getElementById('ghToken').value;
                
                this.setLoading(true, "Salvando na nuvem...");

                try {
                    // 1. Antes de salvar, busca o SHA mais recente para evitar conflito
                    // (Caso algu√©m tenha editado em outro lugar)
                    const checkRes = await fetch(this.getApiUrl(), {
                        headers: { 'Authorization': `token ${token}` }
                    });
                    if(checkRes.ok) {
                        const checkData = await checkRes.json();
                        ghState.sha = checkData.sha;
                    }

                    // 2. Monta o objeto
                    const newDB = montarObjeto();
                    const contentStr = `window.NBV_DB = ${JSON.stringify(newDB, null, 4)};`;
                    const contentBase64 = window.btoa(unescape(encodeURIComponent(contentStr)));

                    // 3. Envia
                    const res = await fetch(this.getApiUrl(), {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: "Update via Admin Panel",
                            content: contentBase64,
                            sha: ghState.sha
                        })
                    });

                    if(!res.ok) throw new Error(await res.text());
                    
                    const resData = await res.json();
                    ghState.sha = resData.content.sha; // Atualiza SHA local
                    alert("‚úÖ Salvo no GitHub com sucesso!");

                } catch(e) {
                    alert("Erro ao salvar: " + e.message);
                } finally {
                    this.setLoading(false);
                }
            }
        };

        // ==========================================
        // MANIPULA√á√ÉO DE DADOS (UI)
        // ==========================================
        function preencherCampos(db) {
            // Textos
            if(db.apresentacao) {
                document.getElementById('txtBook').value = db.apresentacao.book.text || "";
                document.getElementById('imgBook').value = db.apresentacao.book.img || "";
                document.getElementById('txtPrint').value = db.apresentacao.print.text || "";
                document.getElementById('imgPrint').value = db.apresentacao.print.img || "";
            }
            // Financeiro
            document.getElementById('markup').value = db.financeiro.markup;
            document.getElementById('custoFixo').value = db.financeiro.custoFixoDiagramacao;
            document.getElementById('whatsNum').value = db.financeiro.whatsapp;
            document.getElementById('shipPrice').value = db.logistica.taxaEnvio;
            document.getElementById('freeCities').value = db.logistica.cidadesGratis.join(', ');
            if(db.assets) document.getElementById('wmText').value = db.assets.watermarkText || "NBV";
            
            // Listas
            document.getElementById('fotolivro-table').innerHTML = ''; 
            (db.tabelaFotolivros || []).forEach(i => addBookRow(i));

            document.getElementById('produtos-list').innerHTML = ''; 
            (db.produtosAvulsos || []).forEach(i => addProdRow(i));
        }

        function montarObjeto() {
            const db = {
                assets: { watermarkText: document.getElementById('wmText').value, opacity: 0.3 },
                financeiro: {
                    markup: Number(document.getElementById('markup').value),
                    custoFixoDiagramacao: Number(document.getElementById('custoFixo').value),
                    whatsapp: document.getElementById('whatsNum').value
                },
                logistica: {
                    taxaEnvio: Number(document.getElementById('shipPrice').value),
                    cidadesGratis: document.getElementById('freeCities').value.split(',').map(s=>s.trim())
                },
                apresentacao: {
                    book: { text: document.getElementById('txtBook').value, img: document.getElementById('imgBook').value },
                    print: { text: document.getElementById('txtPrint').value, img: document.getElementById('imgPrint').value },
                    digital: { text: "Link para download.", img: "https://via.placeholder.com/400x200?text=Digital" }
                },
                tabelaFotolivros: [],
                produtosAvulsos: [],
                regrasDiagramacao: { "15x20":3, "20x20":4, "20x30":4, "25x25":5, "30x30":6, "30x40":6 }
            };

            document.querySelectorAll('.book-row').forEach(r => {
                db.tabelaFotolivros.push({
                    size: r.querySelector('.bk-size').value,
                    pages: Number(r.querySelector('.bk-pages').value),
                    price: Number(r.querySelector('.bk-price').value)
                });
            });

            document.querySelectorAll('.prod-row').forEach(r => {
                db.produtosAvulsos.push({
                    nome: r.querySelector('.pd-name').value,
                    preco: Number(r.querySelector('.pd-price').value)
                });
            });
            return db;
        }

        // Helpers de UI
        function addBookRow(d={}) {
            document.getElementById('fotolivro-table').insertAdjacentHTML('beforeend', 
            `<div class="list-item book-row">
                <input type="text" class="bk-size" value="${d.size||'20x20'}" style="width:80px" placeholder="Tam">
                <input type="number" class="bk-pages" value="${d.pages||20}" style="width:60px" placeholder="P√°gs">
                <input type="number" class="bk-price" value="${d.price||0}" style="width:80px" placeholder="Custo">
                <button class="btn-remove" onclick="this.parentElement.remove()">X</button>
            </div>`);
        }
        function addProdRow(d={}) {
            document.getElementById('produtos-list').insertAdjacentHTML('beforeend', 
            `<div class="list-item prod-row">
                <input type="text" class="pd-name" value="${d.nome||''}" placeholder="Nome" style="flex:2">
                <input type="number" class="pd-price" value="${d.preco||0}" placeholder="Pre√ßo" style="flex:1">
                <button class="btn-remove" onclick="this.parentElement.remove()">X</button>
            </div>`);
        }
        function addCreditoRow() {
            let opts = '<option value="">Selecione...</option>';
            document.querySelectorAll('.prod-row').forEach(r => {
                const val = r.querySelector('.pd-name').value;
                if(val) opts += `<option value="${val}">${val}</option>`;
            });
            document.getElementById('creditos-list').insertAdjacentHTML('beforeend', 
            `<div class="list-item credito-row">
                <select class="cr-item" style="flex:2">${opts}</select>
                <input type="number" class="cr-qtd" value="1" style="width:70px">
                <button class="btn-remove" onclick="this.parentElement.remove()">X</button>
            </div>`);
        }

        // ==========================================
        // GERADOR DE ZIP (FINAL)
        // ==========================================
        async function gerarSiteCompleto() {
            if(!ghState.isConnected) return alert("Conecte ao GitHub primeiro!");

            const nomeCli = document.getElementById('cliName').value || "Cliente";
            const fotos = document.getElementById('cliFotos').value.split('\n').filter(x => x.trim());
            
            if(fotos.length === 0) return alert("Sem fotos!");

            // Cr√©ditos
            const creditos = [];
            document.querySelectorAll('.credito-row').forEach(r => {
                const item = r.querySelector('.cr-item').value;
                const qtd = Number(r.querySelector('.cr-qtd').value);
                if(item && qtd > 0) creditos.push({ item, qtd });
            });

            // Config Final
            const configDB = montarObjeto();
            const configCliente = {
                ...configDB,
                cliente: { 
                    nome: nomeCli, 
                    entrada: Number(document.getElementById('cliEntrada').value),
                    incluirAlbum: document.getElementById('cliIncluirAlbum').value === 'sim',
                    creditos: creditos
                },
                fluxo: { 
                    pedirEdicao: document.getElementById('fluxoModo').value === 'venda', 
                    minimoFotosLivro: 15 
                }
            };

            // HTML CLIENTE (Integrado, sem arquivos externos)
            const clientHTML = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Pedido NBV - ${nomeCli}</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* ESTILOS */
:root{ --bg:#f8f9fa; --card:#ffffff; --text:#1f2937; --primary:#007bff; --success:#28a745; --border:#dee2e6; --warning:#ffc107; }
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--text);margin:0;padding-bottom:100px}
.container{max-width:800px;margin:0 auto;padding:20px}
.hidden{display:none !important}
.card{background:var(--card);padding:20px;border-radius:12px;margin-bottom:15px;border:1px solid var(--border);box-shadow:0 4px 6px rgba(0,0,0,0.05);position:relative}
h2{margin-top:0;text-align:center;font-size:1.6rem}
h3{margin:0 0 10px 0;font-size:1.2rem;font-weight:700}
.btn{background:var(--primary);color:#fff;border:none;padding:14px;width:100%;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-top:10px;transition:0.2s}
.btn:hover{filter:brightness(0.9)}
.btn-success{background:var(--success)}
.btn-secondary{background:#6c757d}
.btn-outline{background:transparent;border:2px solid var(--primary);color:var(--primary)}
.btn-link{background:none;color:#6b7280;border:none;padding:10px;font-size:0.9rem;text-decoration:underline;cursor:pointer;width:100%}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:15px}
.photo-container{position:relative;background:#eee;min-height:300px;display:flex;align-items:center;justify-content:center;border-radius:8px;overflow:hidden;margin-bottom:20px}
.photo-container img{width:100%;pointer-events:none;display:block}
.watermark-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background-repeat:repeat;background-position:center;pointer-events:none;z-index:10}
.prod-item{padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.stepper{display:flex;gap:5px;align-items:center}
.stepper button{background:#e9ecef;border:none;width:32px;height:32px;border-radius:6px;font-weight:bold;cursor:pointer}
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:999;display:flex;align-items:center;justify-content:center;padding:20px}
.modal-box{background:white;padding:20px;border-radius:12px;max-width:500px;width:100%;max-height:80vh;display:flex;flex-direction:column}
.modal-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:5px;overflow-y:auto}
.thumb-box{position:relative;aspect-ratio:1;overflow:hidden;border-radius:4px;cursor:pointer}
.thumb-box img{width:100%;height:100%;object-fit:cover}
.lightbox-img{max-width:95%;max-height:90%;border:2px solid white}
.price-highlight{font-size:1.3rem;color:var(--primary);font-weight:bold;margin:10px 0}
@keyframes pulse { 0% {transform:scale(1)} 50% {transform:scale(1.02)} 100% {transform:scale(1)} }
.pulse-btn { animation: pulse 2s infinite; }
</style>
</head>
<body>
<div id="app"><div style="text-align:center;padding:50px"><i class="fas fa-spinner fa-spin"></i> Carregando...</div></div>

<script>
window.NBV_CONFIG = ${JSON.stringify(configCliente)};
window.NBV_FOTOS = ${JSON.stringify(fotos)};

const App = {
    data: {},
    state: { view: 'intro', idx: 0, mode: '', sel: [], pag: 'pix', frete: 'sede', modalOpen: false, lightboxUrl: null },

    init() {
        this.data = window.NBV_CONFIG;
        this.data.fotos = window.NBV_FOTOS;
        this.state.sel = this.data.fotos.map(url => ({ inAlbum: false, extras: {} }));
        this.render();
    },

    render() {
        const app = document.getElementById('app');
        const view = this.state.view;
        let html = '';

        if(view === 'intro') {
            html = \`<div class="container">
                <h2>Ol√°, \${this.data.cliente.nome}!</h2>
                <div class="card" style="text-align:center">
                    <p>Temos <strong>\${this.data.fotos.length} fotos</strong> prontas.</p>
                    <button class="btn btn-outline" onclick="App.toggleModalFotos()"><i class="fas fa-th"></i> Espiar Fotos</button>
                </div>
                <div class="card">
                    <p style="text-align:center;font-weight:600">Vamos come√ßar?</p>
                    <button class="btn btn-primary" onclick="App.irParaModo()">Iniciar Pedido ‚ûî</button>
                </div>
            </div>\`;
        }
        else if(view === 'modo') {
            const opcoes = this.calcAlbum(this.data.fotos.length);
            const precoAlbum = opcoes.length > 0 ? this.fmt(opcoes[0].total) : "Sob Consulta";
            const parcAlbum = opcoes.length > 0 ? "ou 12x de " + this.fmt(opcoes[0].parcela) : "";

            html = \`<div class="container">
                <h2>Como deseja produzir?</h2>
                <div class="card" style="border:2px solid var(--primary)">
                    <div style="background:var(--primary);color:white;position:absolute;top:0;right:0;padding:5px 10px;border-radius:0 10px 0 10px;font-size:12px">RECOMENDADO</div>
                    <h3>üìö Fotolivro Premium</h3>
                    <p>Capa dura e diagrama√ß√£o profissional.</p>
                    <div class="price-highlight">\${precoAlbum}</div>
                    <small>\${parcAlbum}</small>
                    <div class="grid-2">
                        <button class="btn btn-primary" onclick="App.setMode('album')">Montar</button>
                        <button class="btn btn-outline" onclick="App.verDet('book')">Detalhes</button>
                    </div>
                </div>
                <div class="card">
                    <h3>üñºÔ∏è Fazer Revela√ß√£o</h3>
                    <p>Fotos avulsas em papel profissional.</p>
                    <div class="grid-2">
                        <button class="btn btn-primary" onclick="App.setMode('avulso')">Revelar</button>
                        <button class="btn btn-outline" onclick="App.verDet('print')">Detalhes</button>
                    </div>
                </div>
                <div class="card">
                    <h3>üíæ Somente Arquivo</h3>
                    <div class="grid-2">
                        <button class="btn btn-primary" onclick="App.irPersuasao()">Arquivos</button>
                        <button class="btn btn-outline" onclick="App.verDet('digital')">Detalhes</button>
                    </div>
                </div>
                <div style="text-align:center;margin-top:20px"><button class="btn-link" onclick="App.toggleModalFotos()">üì∏ Espiar Novamente</button></div>
            </div>\`;
        }
        else if(view === 'persuasao') {
            html = \`<div class="container">
                <button class="btn-secondary" onclick="App.irParaModo()" style="width:auto;margin-bottom:15px">‚Üê Voltar</button>
                <div class="card" style="border:2px solid var(--warning);background:#fffdf5">
                    <h2 style="color:#d97706">‚ö†Ô∏è Espere um pouco!</h2>
                    <p>Arquivos digitais se perdem. Papel dura gera√ß√µes.</p>
                    <ul>
                        <li>‚úÖ <strong>Durabilidade:</strong> Papel profissional.</li>
                        <li>‚úÖ <strong>Cores Reais:</strong> Telas enganam.</li>
                        <li>‚úÖ <strong>Ganhe o Digital:</strong> Ao revelar, o arquivo √© brinde!</li>
                    </ul>
                    <button class="btn btn-primary pulse-btn" onclick="App.setMode('avulso')">‚ú® Quero Revelar (Melhor Op√ß√£o)</button>
                    <div style="margin-top:30px;text-align:center">
                        <button class="btn btn-secondary" style="width:auto;background:#e0e0e0;color:#555" onclick="App.checkoutDig()">Continuar com Arquivos</button>
                    </div>
                </div>
            </div>\`;
        }
        else if(view === 'detalhes') {
            const d = this.data.apresentacao[this.state.detTipo];
            html = \`<div class="container">
                <button class="btn-secondary" onclick="App.irParaModo()" style="width:auto;margin-bottom:15px">‚Üê Voltar</button>
                <div class="card">
                    <img src="\${d.img}" style="height:200px;object-fit:cover;margin-bottom:15px">
                    <h3>Detalhes</h3>
                    <p>\${d.text}</p>
                    <button class="btn btn-primary" onclick="App.acaoDet()">Continuar</button>
                </div>
            </div>\`;
        }
        else if(view === 'workstation') {
            const i = this.state.idx;
            const f = this.data.fotos[i];
            const sel = this.state.sel[i];
            const svg = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(\`<svg width='300' height='150' xmlns='http://www.w3.org/2000/svg'><text x='50%' y='50%' transform='rotate(-20 150 75)' text-anchor='middle' font-family='Arial' font-weight='bold' font-size='20' fill='#000' fill-opacity='\${this.data.assets.opacity}'>\${this.data.assets.watermarkText}</text></svg>\`);
            
            html = \`<div class="container">
                <button class="btn-secondary" onclick="App.irParaModo()" style="width:auto;margin-bottom:10px;padding:5px 10px;font-size:0.8rem">‚úñ Sair</button>
                <div class="photo-container">
                    <img src="\${f}" oncontextmenu="return false">
                    <div class="watermark-overlay" style="background-image:url('\${svg}')"></div>
                </div>
                \${this.state.mode==='album' ? \`<div class="card" onclick="App.togAlb()" style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;border:2px solid \${sel.inAlbum?'var(--success)':'#eee'}"><div><strong>üìö No √Ålbum</strong></div><i class="fas \${sel.inAlbum?'fa-check-circle':'fa-circle'}" style="font-size:28px;color:\${sel.inAlbum?'var(--success)':'#ccc'}"></i></div>\` : ''}
                <div class="card">
                    <h3 style="font-size:1rem">Revelar esta foto:</h3>
                    \${this.renderProds(sel)}
                </div>
                <div class="grid-2">
                    <button class="btn btn-secondary" onclick="App.nav(-1)" \${i===0?'disabled style="opacity:0.5"':''}>‚ùÆ Anterior</button>
                    \${i < this.data.fotos.length-1 ? \`<button class="btn btn-primary" onclick="App.nav(1)">Pr√≥xima ‚ùØ</button>\` : \`<button class="btn btn-success" onclick="App.checkout()">Finalizar ‚úì</button>\`}
                </div>
                <div style="text-align:center;margin-top:10px;color:#999">\${i+1} de \${this.data.fotos.length}</div>
            </div>\`;
        }
        else if(view === 'checkout') {
            const res = this.calcTotal();
            html = \`<div class="container">
                <h2>Resumo</h2>
                <div class="card" style="font-family:monospace;white-space:pre-wrap;background:#f8f9fa;font-size:13px">\${res.txt}</div>
                <div class="card">
                    <h3>üöö Entrega</h3>
                    <select id="frete" onchange="App.setFrete(this.value)">
                        <option value="sede">Retirar na Sede</option>
                        <option value="transp">Transportadora (+ \${this.fmt(this.data.logistica.taxaEnvio)})</option>
                        <option value="gratis">Frete Gr√°tis (\${this.data.logistica.cidadesGratis.join(', ')})</option>
                    </select>
                    \${this.state.frete!=='sede'?'<input type="text" id="end" placeholder="Endere√ßo">':''}
                </div>
                <div class="card">
                    <h3>üí≥ Pagamento</h3>
                    <div style="display:flex;justify-content:space-between;font-size:1.4rem;font-weight:bold;color:var(--success);margin-bottom:15px"><span>Total:</span><span>\${this.fmt(res.total)}</span></div>
                    <select id="pag" onchange="App.setPag(this.value)">
                        <option value="pix">Pix (5% Off)</option>
                        <option value="cartao">Cart√£o</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="App.zap()"><i class="fab fa-whatsapp"></i> Enviar Pedido</button>
                <button class="btn btn-outline" onclick="App.irParaModo()" style="margin-top:15px">Voltar</button>
            </div>\`;
        }

        app.innerHTML = html;
        if(this.state.modalOpen) this.renderModal();
        if(this.state.lightboxUrl) this.renderLightbox();
    },

    // AUXILIARES
    renderProds(sel) {
        let h = '';
        const prints = this.data.produtosAvulsos.filter(p=>p.nome.includes('Foto')||p.nome.includes('Revel'));
        const frames = this.data.produtosAvulsos.filter(p=>p.nome.includes('Moldura')||p.nome.includes('Porta'));
        const dig = this.data.produtosAvulsos.find(p=>p.nome.includes('Digital'));
        
        prints.forEach(p => {
            h += this.stepItem(p, sel.extras[p.nome]||0);
            if((sel.extras[p.nome]||0) > 0) {
                const dim = p.nome.match(/\\d+x\\d+/);
                if(dim) {
                    const fr = frames.find(f=>f.nome.includes(dim[0]));
                    if(fr) h += \`<div style="margin-left:20px;background:#fafafa;padding:5px;border-left:2px solid #ccc"><small>Moldura?</small>\${this.stepItem(fr, sel.extras[fr.nome]||0)}</div>\`;
                }
            }
        });
        if(dig) {
            const hasPrint = Object.keys(sel.extras).some(k=>k.includes('Foto')||k.includes('Revel'));
            if(hasPrint) {
                 if(sel.extras[dig.nome]) delete sel.extras[dig.nome];
                 h += \`<div class="prod-item" style="opacity:0.7;background:#e8f5e9"><div style="font-size:14px">Arquivo Digital <span style="background:green;color:white;font-size:10px;padding:2px">BRINDE</span></div><i class="fas fa-check" style="color:green"></i></div>\`;
            } else {
                 h += this.stepItem(dig, sel.extras[dig.nome]||0);
            }
        }
        return h;
    },
    stepItem(p, q) {
        return \`<div class="prod-item"><div><div style="font-size:14px">\${p.nome}</div><div style="font-size:12px;color:#666">\${this.fmt(p.preco)}</div></div>
        <div class="stepper"><button onclick="App.add('\${p.nome}',-1)">-</button><span>\${q}</span><button onclick="App.add('\${p.nome}',1)" style="background:var(--primary);color:white">+</button></div></div>\`;
    },
    
    toggleModalFotos() { this.state.modalOpen = !this.state.modalOpen; this.render(); },
    renderModal() {
        const svg = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(\`<svg width='150' height='150' xmlns='http://www.w3.org/2000/svg'><text x='50%' y='50%' transform='rotate(-45 75 75)' text-anchor='middle' font-family='Arial' font-weight='bold' font-size='16' fill='#000' fill-opacity='0.3'>NBV</text></svg>\`);
        const imgs = this.data.fotos.map(u => \`<div class="thumb-box" onclick="App.openLb('\${u}')"><img src="\${u}"><div class="watermark-overlay" style="background-image:url('\${svg}')"></div></div>\`).join('');
        document.body.insertAdjacentHTML('beforeend', \`<div class="modal-overlay" onclick="if(event.target===this) App.toggleModalFotos()"><div class="modal-box"><h3>Galeria</h3><div class="modal-grid">\${imgs}</div><button class="btn btn-outline" style="margin-top:10px" onclick="App.toggleModalFotos()">Fechar</button></div></div>\`);
    },
    openLb(u) { this.state.lightboxUrl = u; this.render(); },
    renderLightbox() {
        document.body.insertAdjacentHTML('beforeend', \`<div class="modal-overlay" style="z-index:2000" onclick="App.closeLb()"><img src="\${this.state.lightboxUrl}" class="lightbox-img"><button style="position:absolute;top:20px;right:20px;background:none;border:none;color:white;font-size:40px;cursor:pointer" onclick="App.closeLb()">&times;</button></div>\`);
    },
    closeLb() { this.state.lightboxUrl = null; this.render(); },
    
    irParaModo() { this.state.view = 'modo'; this.render(); },
    setMode(m) { this.state.mode = m; this.state.view = 'workstation'; this.state.idx=0; this.render(); },
    irPersuasao() { this.state.view = 'persuasao'; this.render(); },
    checkoutDig() { this.state.mode = 'arq_full'; this.state.view = 'checkout'; this.render(); },
    verDet(t) { this.state.detTipo = t; this.state.view = 'detalhes'; this.render(); },
    acaoDet() { 
        if(this.state.detTipo==='book') this.setMode('album'); 
        else if(this.state.detTipo==='print') this.setMode('avulso');
        else this.irParaModo();
    },
    nav(d) { this.state.idx += d; this.render(); },
    togAlb() { this.state.sel[this.state.idx].inAlbum = !this.state.sel[this.state.idx].inAlbum; this.render(); },
    add(n, d) { 
        let v = (this.state.sel[this.state.idx].extras[n]||0) + d;
        if(v<=0) delete this.state.sel[this.state.idx].extras[n];
        else this.state.sel[this.state.idx].extras[n] = v;
        this.render();
    },
    checkout() { 
        if(this.calcTotal().total===0) return alert("Selecione algo!");
        this.state.view='checkout'; this.render(); 
    },
    setFrete(v) { this.state.frete = v; this.render(); },
    setPag(v) { this.state.pag = v; },

    // CALCULOS DE CR√âDITO
    calcAlbum(qtd) {
        const ts = [...new Set(this.data.tabelaFotolivros.map(t=>t.size))];
        const res = [];
        ts.forEach(tam => {
            const fpp = this.data.regrasDiagramacao[tam] || 4;
            const pags = Math.ceil(qtd/fpp);
            const mtc = this.data.tabelaFotolivros.filter(t=>t.size===tam).sort((a,b)=>a.pages-b.pages).find(t=>t.pages>=pags);
            if(mtc) {
                const tot = (mtc.price + this.data.financeiro.custoFixoDiagramacao) * this.data.financeiro.markup;
                res.push({ nome: \`Fotolivro \${tam}\`, total: tot, parcela: (tot*1.2)/12 });
            }
        });
        return res;
    },
    calcTotal() {
        let t = 0, txt = "";
        
        if(this.state.mode==='album') {
            const q = this.state.sel.filter(s=>s.inAlbum).length;
            if(q>0) {
                const op = this.calcAlbum(q)[0];
                if(op) { t += op.total; txt += \`üìö \${op.nome}: \${q} fotos (\${this.fmt(op.total)})\n\`; }
            }
        } else if(this.state.mode==='arq_full') {
            const qtd = this.data.fotos.length;
            const pd = this.data.produtosAvulsos.find(p=>p.nome.includes('Digital'));
            if(pd) { t += qtd*pd.preco; txt += \`üíæ Pacote Digital: \${qtd} fotos (\${this.fmt(t)})\n\`; }
        }
        
        let av = "";
        const creditosUsados = {}; 

        this.state.sel.forEach((s,i) => {
            Object.keys(s.extras).forEach(k => {
                if(k.includes('Digital') && Object.keys(s.extras).some(kk=>kk.includes('Foto'))) return;
                
                const p = this.data.produtosAvulsos.find(x=>x.nome===k);
                if(p) { 
                    let qtdParaCobrar = s.extras[k];
                    const credito = (this.data.cliente.creditos || []).find(c => c.item === k);
                    let infoCred = "";
                    
                    if(credito) {
                        const usados = creditosUsados[k] || 0;
                        const disponiveis = credito.qtd - usados;
                        
                        if(disponiveis > 0) {
                            const abatidos = Math.min(qtdParaCobrar, disponiveis);
                            qtdParaCobrar -= abatidos;
                            creditosUsados[k] = usados + abatidos;
                            infoCred = \` (Incluso)\`; 
                        }
                    }

                    const st = p.preco * qtdParaCobrar;
                    t += st; 
                    av += \`Foto \${i+1}: \${s.extras[k]}x \${k}\${infoCred} (\${this.fmt(st)})\n\`; 
                }
            });
        });
        if(av) txt += \`üñºÔ∏è Avulsos:\n\${av}\`;
        
        if(this.state.frete==='transp') { t += this.data.logistica.taxaEnvio; txt += \`üöö Frete: \${this.fmt(this.data.logistica.taxaEnvio)}\n\`; }
        if(this.data.cliente.entrada > 0) { t -= this.data.cliente.entrada; txt += \`üí∞ Entrada: -\${this.fmt(this.data.cliente.entrada)}\n\`; }
        if(t<0) t=0;
        return { total: t, txt: txt };
    },
    fmt(v) { return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); },
    zap() {
        const res = this.calcTotal();
        let msg = \`*PEDIDO - \${this.data.cliente.nome}*\n----------------\n\${res.txt}\n----------------\n*TOTAL: \${this.fmt(res.total)}*\nPagamento: \${this.state.pag}\`;
        if(this.state.frete!=='sede') msg += \`\nEntrega: \${document.getElementById('end')?document.getElementById('end').value:'A combinar'}\`;
        window.open(\`https://wa.me/\${this.data.financeiro.whatsapp}?text=\${encodeURIComponent(msg)}\`);
    }
};
App.init();
<\/script></body></html>`;

            const zip = new JSZip();
            zip.file("index.html", clientHTML);
            zip.generateAsync({type:"blob"}).then(function(content) {
                saveAs(content, `Pedido_${nomeCli.replace(/\s+/g,'_')}.zip`);
            });
        }
    </script>
</body>
</html>
