<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>NBV Command Center V7.2</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="js/database.js"></script>

    <style>
        :root { --primary: #0066cc; --bg: #f3f4f6; --sidebar: #fff; --text: #1f2937; --border: #e5e7eb; --danger: #dc2626; --success: #16a34a; --highlight: #e0f2fe; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 280px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.02); }
        .nav-btn { width: 100%; text-align: left; padding: 12px; margin-bottom: 5px; cursor: pointer; border: none; background: none; color: #666; font-weight: 500; display: flex; align-items: center; gap: 10px; border-radius: 6px; transition: 0.2s; }
        .nav-btn:hover { background: #f9fafb; color: var(--primary); }
        .nav-btn.active { background: #eff6ff; color: var(--primary); font-weight: 700; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .section { display: none; } .section.active { display: block; animation: fadeIn 0.3s ease; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.9rem; color: #374151; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }
        .row { display: flex; gap: 15px; } .col { flex: 1; }
        .list-item { background: #fff; border: 1px solid var(--border); padding: 10px; border-radius: 6px; margin-bottom: 8px; display: flex; gap: 10px; align-items: center; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); } .btn-success { background: var(--success); } .btn-github { background: #24292e; } .btn-add { background: #ecfdf5; color: var(--success); border: 1px dashed var(--success); }
        .table-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 5px; margin-bottom: 5px; }
        .btn-remove { background: #fee2e2; color: var(--danger); border: none; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        #log-area { margin-top: 10px; font-size: 0.75rem; color: #666; max-height: 80px; overflow-y: auto; background: #fff; padding: 5px; border: 1px solid #eee; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2 style="margin:0 0 20px; font-size:1.4rem; color:#333"><i class="fas fa-camera"></i> Studio<span style="color:var(--primary)">NBV</span></h2>
        <nav>
            <button class="nav-btn active" onclick="showTab('tab-cliente')"><i class="fas fa-user"></i> Cliente & Config</button>
            <button class="nav-btn" onclick="showTab('tab-fotolivro')"><i class="fas fa-book"></i> Tabela Fotolivros</button>
            <button class="nav-btn" onclick="showTab('tab-produtos')"><i class="fas fa-images"></i> Produtos Avulsos</button>
            <button class="nav-btn" onclick="showTab('tab-financeiro')"><i class="fas fa-coins"></i> Financeiro & Log.</button>
            <button class="nav-btn" onclick="showTab('tab-github')"><i class="fab fa-github"></i> Conex√£o GitHub</button>
        </nav>
        
        <div style="margin-top:auto; padding-top:15px; border-top:1px solid #eee">
            <button class="btn btn-primary" onclick="gerarZip()" style="padding:15px; font-size:1.1rem">
                <i class="fas fa-file-zipper"></i> GERAR SITE COMPLETO
            </button>
            <small style="display:block; color:#666; margin-top:5px; text-align:center">Inclui index.html (venda) e galeria.html (entrega)</small>
            
            <button class="btn btn-github" onclick="salvarNoGithub()">
                <i class="fas fa-cloud-upload-alt"></i> SALVAR DB
            </button>
            <div id="log-area">Pronto.</div>
        </div>
    </div>

    <div class="main-content">

        <div id="tab-cliente" class="section active">
            <h2>Dados do Cliente</h2>
            <div class="form-group"><label>Nome do Cliente</label><input type="text" id="cliName" placeholder="Ex: Casamento Maria"></div>
            <div class="form-group">
                <label>Links das Fotos (Alta Resolu√ß√£o)</label>
                <textarea id="cliFotos" rows="8" placeholder="https://..."></textarea>
                <small style="color:#666">
                    Estas fotos aparecer√£o na <b>Sele√ß√£o</b> (com marca d'√°gua autom√°tica) e na <b>galeria.html</b> (limpas para download).
                </small>
            </div>
            
            <h4>Prote√ß√£o & Fluxo (Site de Venda)</h4>
            <div class="row">
                <div class="col" style="flex:2"><div class="form-group"><label>Texto Marca D'√°gua</label><input type="text" id="wmText" placeholder="NBV - PROIBIDO PRINT"></div></div>
                <div class="col" style="flex:1"><div class="form-group"><label>Opacidade (0.1-1)</label><input type="number" id="wmOp" step="0.1" max="1" min="0.1"></div></div>
            </div>
            <div class="row">
                <div class="col"><label class="list-item"><input type="checkbox" id="fluxoEdicao"> Perguntar Edi√ß√£o?</label></div>
                <div class="col"><label class="list-item"><input type="checkbox" id="fluxoAprovacao"> Aprova√ß√£o de Fotos?</label></div>
            </div>

            <h4>Contrato Financeiro</h4>
            <div class="row">
                <div class="col"><div class="form-group"><label>Entrada Paga (R$)</label><input type="number" id="cliEntrada" value="0.00"></div></div>
                <div class="col"><div class="form-group"><label>Incluir Fotolivro?</label><select id="cliIncluirAlbum" onchange="toggleContrato()"><option value="nao">N√£o</option><option value="sim">Sim (Contrato)</option></select></div></div>
            </div>

            <div id="detalhes-contrato" style="display:none; background:var(--highlight); padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #bae6fd">
                <h5 style="margin:0 0 10px; color:var(--primary)">Dados do Contrato (Para Upgrade)</h5>
                <div class="row">
                    <div class="col"><label>Valor TOTAL Contrato (R$)</label><input type="number" id="ctrValorTotal" placeholder="Ex: 2000.00"></div>
                </div>
                <div class="row" style="margin-top:10px">
                    <div class="col"><label>Tamanho Base</label><select id="ctrSize"><option value="15x20">15x20</option><option value="20x30">20x30</option><option value="30x40">30x40</option></select></div>
                    <div class="col"><label>Qtd. Fotos Base</label><input type="number" id="ctrQtdFotos" value="20"></div>
                </div>
            </div>

            <div class="form-group"><label>Cr√©ditos Extras</label><div id="creditos-list"></div><button class="btn btn-add" onclick="addCreditoRow()">+ Adicionar Item</button></div>
        </div>

        <div id="tab-fotolivro" class="section">
            <h2>Tabela Fotolivros</h2>
            <div class="row">
                <div class="col"><label>Markup</label><input type="number" id="markup" step="0.1"></div>
                <div class="col"><label>Custo Fixo</label><input type="number" id="custoFixo"></div>
                <div class="col"><label>M√≠nimo Fotos</label><input type="number" id="minFotosLivro"></div>
            </div>
            <div style="font-weight:bold; display:grid; grid-template-columns:1fr 1fr 1fr 1fr auto; gap:5px; margin:10px 0 5px; font-size:0.8rem"><span>Tam</span><span>P√°gs</span><span>Base</span><span>Caixa</span><span></span></div>
            <div id="fotolivro-table"></div>
            <button class="btn btn-add" onclick="addBookRow()">+ Linha</button>
            <h4 style="margin-top:20px">Regras (Fotos/P√°g)</h4>
            <div id="regras-container"></div>
        </div>

        <div id="tab-produtos" class="section"><h3>Produtos Avulsos</h3><div id="produtos-list"></div><button class="btn btn-add" onclick="addProdRow()">+ Produto</button></div>

        <div id="tab-financeiro" class="section">
            <h2>Financeiro & Log√≠stica</h2>
            <div class="row"><div class="col"><label>Desc. Pix %</label><input type="number" id="pixDesc"></div><div class="col"><label>S/ Juros</label><input type="number" id="noInterest"></div></div>
            <div class="form-group"><label>Juros (1x..12x)</label><input type="text" id="ratesTable"></div>
            <div class="form-group"><label>Whatsapp</label><input type="text" id="whatsNum"></div>
            
            <h4>Log√≠stica</h4>
            <div class="form-group"><label>Cidades Gr√°tis</label><input type="text" id="freeCities"></div>
            <div class="form-group"><label>Endere√ßo Sede</label><input type="text" id="sedeAddress"></div>
            <div class="form-group"><label>Frete Transp. (R$)</label><input type="number" id="shipPrice"></div>
        </div>

        <div id="tab-github" class="section"><h3>GitHub</h3><div class="form-group"><label>Token</label><input type="password" id="ghToken"></div><div class="form-group"><label>User</label><input type="text" id="ghUser"></div><div class="form-group"><label>Repo</label><input type="text" id="ghRepo"></div><button class="btn btn-primary" onclick="salvarCredenciaisLocal()">Salvar</button></div>
    </div>

    <script>
        window.onload = function() { carregarCredenciaisLocal(); if(window.NBV_DB) carregarDB(window.NBV_DB); else alert("Use Live Server!"); };

        function carregarDB(db) {
            // Mapeamento Simples
            const simple = { markup:'financeiro.markup', custoFixo:'financeiro.custoFixoDiagramacao', pixDesc:'financeiro.descontoPix', noInterest:'financeiro.parcelasSemJuros', shipPrice:'logistica.taxaEnvio', minFotosLivro:'fluxo.minimoFotosLivro', whatsNum:'financeiro.whatsapp', sedeAddress:'logistica.enderecoSede' };
            for(let id in simple) try { document.getElementById(id).value = eval('db.'+simple[id]); } catch(e){}
            
            // Campos Compostos
            document.getElementById('ratesTable').value = db.financeiro.tabelaJuros.join(', ');
            document.getElementById('freeCities').value = db.logistica.cidadesGratis.join(', ');
            document.getElementById('fluxoEdicao').checked = db.fluxo.pedirEdicao;
            document.getElementById('fluxoAprovacao').checked = db.fluxo.pedirAprovacao;
            document.getElementById('wmText').value = db.assets ? db.assets.watermarkText : "NBV - PROIBIDO PRINT";
            document.getElementById('wmOp').value = db.assets ? db.assets.opacity : 0.2;

            // Tabelas
            const tbL = document.getElementById('fotolivro-table'); tbL.innerHTML=''; db.tabelaFotolivros.forEach(i=>addBookRow(i));
            const tbP = document.getElementById('produtos-list'); tbP.innerHTML=''; db.produtosAvulsos.forEach(i=>addProdRow(i));
            const reg = document.getElementById('regras-container'); reg.innerHTML='';
            for(let k in db.regrasDiagramacao) reg.innerHTML += `<div class="list-item"><b style="width:60px">${k}</b> <input type="number" class="regra-input" data-size="${k}" value="${db.regrasDiagramacao[k]}" style="width:60px"> fotos/p√°g</div>`;
        }

        function montarConfig() {
            const livros = []; document.querySelectorAll('.book-row').forEach(r => livros.push({ size: r.querySelector('.bk-size').value, pages: Number(r.querySelector('.bk-pages').value), price: Number(r.querySelector('.bk-price').value), priceBox: Number(r.querySelector('.bk-box').value) }));
            const prods = []; document.querySelectorAll('.prod-row').forEach(r => prods.push({ nome: r.querySelector('.pd-name').value, preco: Number(r.querySelector('.pd-price').value), icone: r.querySelector('.pd-icon').value }));
            const regras = {}; document.querySelectorAll('.regra-input').forEach(i => regras[i.dataset.size] = Number(i.value));
            const creds = []; document.querySelectorAll('.credito-row').forEach(r => creds.push({ item: r.querySelector('.cred-name').value, qtd: Number(r.querySelector('.cred-qtd').value) }));

            return {
                cliente: {
                    nome: document.getElementById('cliName').value,
                    entrada: Number(document.getElementById('cliEntrada').value),
                    incluirAlbum: document.getElementById('cliIncluirAlbum').value === 'sim',
                    contrato: { 
                        valorTotal: Number(document.getElementById('ctrValorTotal').value),
                        tamanho: document.getElementById('ctrSize').value,
                        qtdFotos: Number(document.getElementById('ctrQtdFotos').value)
                    },
                    creditos: creds
                },
                assets: {
                    watermarkText: document.getElementById('wmText').value,
                    opacity: Number(document.getElementById('wmOp').value)
                },
                fotos: document.getElementById('cliFotos').value.split('\n').filter(x=>x.trim()),
                financeiro: {
                    markup: Number(document.getElementById('markup').value),
                    custoFixoDiagramacao: Number(document.getElementById('custoFixo').value),
                    descontoPix: Number(document.getElementById('pixDesc').value),
                    parcelasSemJuros: Number(document.getElementById('noInterest').value),
                    tabelaJuros: document.getElementById('ratesTable').value.split(',').map(Number),
                    whatsapp: document.getElementById('whatsNum').value
                },
                logistica: {
                    taxaEnvio: Number(document.getElementById('shipPrice').value),
                    cidadesGratis: document.getElementById('freeCities').value.split(',').map(s => s.trim()),
                    enderecoSede: document.getElementById('sedeAddress').value,
                    locaisRetirada: []
                },
                fluxo: {
                    pedirEdicao: document.getElementById('fluxoEdicao').checked,
                    pedirAprovacao: document.getElementById('fluxoAprovacao').checked,
                    minimoFotosLivro: Number(document.getElementById('minFotosLivro').value)
                },
                tabelaFotolivros: livros, regrasDiagramacao: regras, produtosAvulsos: prods
            };
        }

        // --- GERA O HTML DA GALERIA ---
        function criarHtmlGaleria(nome, fotos) {
            const fotosJson = JSON.stringify(fotos);
            return `<!DOCTYPE html><html lang="pt-BR"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Galeria - ${nome}</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"><link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Montserrat',sans-serif;background-color:#f8f9fa;color:#333;line-height:1.6}.header{background-color:#e0e0e0;color:#333;padding:2.5rem 1rem;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.08);border-bottom:1px solid #d4d4d4}.header h1{font-size:2.8rem;font-weight:300;margin-bottom:0.7rem;letter-spacing:1.5px;color:#222}.header p{font-size:1.2rem;opacity:0.85;font-weight:400;color:#555}.photographer-info{margin-top:1.2rem;font-size:0.95rem;opacity:0.7;font-weight:500;color:#555}.gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px;padding:2rem 1rem;max-width:1400px;margin:0 auto}.photo-item{position:relative;overflow:hidden;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,0.1);cursor:pointer;transition:all 0.3s ease;aspect-ratio:3/4;background:#e9ecef}.photo-item:hover{transform:translateY(-5px);box-shadow:0 8px 25px rgba(0,0,0,0.15)}.photo-item img{width:100%;height:100%;object-fit:cover;transition:transform 0.3s ease}.photo-item:hover img{transform:scale(1.05)}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:1000;align-items:center;justify-content:center}.modal.active{display:flex}.modal-content{position:relative;max-width:90%;max-height:90%;display:flex;align-items:center;justify-content:center}.modal-img{max-width:100%;max-height:80vh;border-radius:8px;box-shadow:0 10px 40px rgba(0,0,0,0.3);object-fit:contain}.modal-nav{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.2);border:none;color:white;font-size:2rem;padding:15px;cursor:pointer;border-radius:50%;transition:background 0.3s ease;z-index:1010}.modal-nav:hover{background:rgba(255,255,255,0.3)}.prev{left:20px}.next{right:20px}.close{position:absolute;top:20px;right:30px;color:white;font-size:3rem;cursor:pointer;transition:transform 0.3s ease;z-index:1020}.close:hover{transform:rotate(90deg)}@media(max-width:768px){.header h1{font-size:2rem}.gallery{grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;padding:1rem}.modal-img{max-height:70vh}.modal-nav{font-size:1.5rem;padding:10px}.prev{left:10px}.next{right:10px}}@media(max-width:480px){.header{padding:1.5rem 1rem}.header h1{font-size:1.5rem}.gallery{grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}}.loading{display:flex;justify-content:center;align-items:center;height:200px;font-size:1.2rem;color:#666;grid-column:1 / -1}.loading i{margin-right:10px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style></head><body><header class="header"><h1 id="event-title">Galeria de Fotos</h1><p>Studio NBV - Thiago Henrique</p><div class="photographer-info">Fot√≥grafo: Thiago Henrique | Studio: Studio NBV</div></header><div class="gallery" id="photo-gallery"><div class="loading"><i class="fas fa-spinner"></i> Carregando galeria...</div></div><div class="modal" id="photo-modal"><span class="close" aria-label="Fechar">&times;</span><button class="modal-nav prev" aria-label="Foto Anterior">&#10094;</button><div class="modal-content"><img class="modal-img loading-modal" id="modal-image" src="" alt="" download></div><button class="modal-nav next" aria-label="Pr√≥xima Foto">&#10095;</button></div><script>
            const photoUrls = ${fotosJson};
            const eventTitle = "${nome}";
            if (eventTitle) document.getElementById('event-title').textContent = eventTitle;
            const gallery = document.getElementById('photo-gallery');
            const modal = document.getElementById('photo-modal');
            const modalImage = document.getElementById('modal-image');
            const closeBtn = document.querySelector('.close');
            const prevBtn = document.querySelector('.prev');
            const nextBtn = document.querySelector('.next');
            let currentPhotoIndex = 0;
            function createGallery() {
                gallery.innerHTML = '';
                photoUrls.forEach((hqUrl, index) => {
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-item';
                    photoItem.innerHTML = '<img src="' + hqUrl + '" alt="Foto ' + (index + 1) + '">';
                    photoItem.addEventListener('click', () => { openModal(index); });
                    gallery.appendChild(photoItem);
                });
            }
            function updateModalImage() {
                const hqUrl = photoUrls[currentPhotoIndex];
                modalImage.classList.add('loading-modal');
                modalImage.alt = 'Foto ' + (currentPhotoIndex + 1);
                modalImage.setAttribute('download', 'NBV_' + (currentPhotoIndex + 1) + '.jpg');
                const tempImg = new Image();
                tempImg.onload = () => { modalImage.src = hqUrl; modalImage.classList.remove('loading-modal'); };
                tempImg.src = hqUrl;
            }
            function openModal(index) { currentPhotoIndex = index; updateModalImage(); modal.classList.add('active'); document.body.style.overflow = 'hidden'; }
            function closeModal() { modal.classList.remove('active'); document.body.style.overflow = 'auto'; }
            function navigate(direction) { if (direction === 'next') currentPhotoIndex = (currentPhotoIndex + 1) % photoUrls.length; else currentPhotoIndex = (currentPhotoIndex - 1 + photoUrls.length) % photoUrls.length; updateModalImage(); }
            closeBtn.addEventListener('click', closeModal); prevBtn.addEventListener('click', () => navigate('prev')); nextBtn.addEventListener('click', () => navigate('next'));
            modal.addEventListener('click', (e) => { if (e.target === modal || e.target === closeBtn) closeModal(); });
            document.addEventListener('keydown', (e) => { if (modal.classList.contains('active')) { if (e.key === 'Escape') closeModal(); else if (e.key === 'ArrowLeft') navigate('prev'); else if (e.key === 'ArrowRight') navigate('next'); } });
            window.addEventListener('load', createGallery);
            <\/script></body></html>`;
        }

        // --- GERA O PACOTE UNIFICADO (index.html + galeria.html) ---
        async function gerarZip() {
            const config = montarConfig();
            if(!config.cliente.nome) return alert("Preencha o Nome do Cliente!");
            if(config.fotos.length === 0) return alert("Cole os links das fotos!");

            log("‚è≥ Gerando Site Completo...");
            
            try {
                const zip = new JSZip();
                
                // 1. Configura√ß√£o do Sistema de Vendas
                zip.file("config_cliente.js", `window.NBV_CONFIG = ${JSON.stringify(config, null, 4)};`);
                
                // 2. Arquivos do Sistema (core, modules, css)
                const files = [
                    'index.html', 'style.css',
                    'js/core.js', 'js/mod_aprovacao.js', 'js/mod_producao.js', 
                    'js/mod_entrega.js', 'js/mod_pagamento.js', 'js/database.js'
                ];

                for(let f of files) {
                    const resp = await fetch(f);
                    if(!resp.ok) throw new Error("Arquivo n√£o encontrado: " + f);
                    zip.file(f, await resp.text());
                }

                // 3. GERA√á√ÉO DA GALERIA FINAL (galeria.html)
                // Inclui no mesmo ZIP para upload √∫nico no Netlify
                const htmlGaleria = criarHtmlGaleria(config.cliente.nome, config.fotos);
                zip.file("galeria.html", htmlGaleria);

                const content = await zip.generateAsync({type:"blob"});
                saveAs(content, `Site_${config.cliente.nome.replace(/\s+/g, '_')}.zip`);
                log("üöÄ ZIP Gerado com Sucesso!");
                log("üëâ Conte√∫do: index.html (venda) + galeria.html (entrega)");

            } catch(e) {
                log("‚ùå Erro ZIP: " + e.message);
                alert("Erro ao gerar ZIP: " + e.message);
            }
        }

        // Helpers
        function toggleContrato() { document.getElementById('detalhes-contrato').style.display = document.getElementById('cliIncluirAlbum').value === 'sim' ? 'block' : 'none'; }
        function showTab(id) { document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); document.getElementById(id).classList.add('active'); event.currentTarget.classList.add('active'); }
        function addBookRow(d={}) { document.getElementById('fotolivro-table').insertAdjacentHTML('beforeend', `<div class="table-row book-row"><select class="bk-size"><option value="15x20" ${d.size=='15x20'?'selected':''}>15x20</option><option value="20x30" ${d.size=='20x30'?'selected':''}>20x30</option><option value="30x40" ${d.size=='30x40'?'selected':''}>30x40</option></select><input type="number" class="bk-pages" value="${d.pages||''}" placeholder="P√°gs"><input type="number" class="bk-price" value="${d.price||''}" placeholder="Base"><input type="number" class="bk-box" value="${d.priceBox||''}" placeholder="Caixa"><button class="btn-remove" onclick="this.parentElement.remove()">X</button></div>`); }
        function addProdRow(d={}) { document.getElementById('produtos-list').insertAdjacentHTML('beforeend', `<div class="list-item prod-row"><input type="text" class="pd-name" value="${d.nome||''}" placeholder="Nome" style="flex:2"><input type="number" class="pd-price" value="${d.preco||''}" placeholder="R$" style="flex:1"><input type="text" class="pd-icon" value="${d.icone||'fas fa-image'}" style="flex:1"><button class="btn-remove" onclick="this.parentElement.remove()">X</button></div>`); }
        function addCreditoRow(d={}) {
            let opts = '<option value="">-- Item --</option>';
            document.querySelectorAll('.prod-row .pd-name').forEach(i => { if(i.value) opts += `<option value="${i.value}" ${d.item==i.value?'selected':''}>${i.value}</option>`; });
            document.getElementById('creditos-list').insertAdjacentHTML('beforeend', `<div class="list-item credito-row"><select class="cred-name" style="flex:2">${opts}</select><input type="number" class="cred-qtd" value="${d.qtd||1}" style="width:60px"><button class="btn-remove" onclick="this.parentElement.remove()">X</button></div>`);
        }
        function log(msg) { document.getElementById('log-area').innerHTML = msg + "<br>" + document.getElementById('log-area').innerHTML; }
        
        function salvarCredenciaisLocal() { localStorage.setItem('ghToken', document.getElementById('ghToken').value); localStorage.setItem('ghUser', document.getElementById('ghUser').value); localStorage.setItem('ghRepo', document.getElementById('ghRepo').value); alert('Salvo!'); }
        function carregarCredenciaisLocal() { if(localStorage.getItem('ghToken')) document.getElementById('ghToken').value = localStorage.getItem('ghToken'); if(localStorage.getItem('ghUser')) document.getElementById('ghUser').value = localStorage.getItem('ghUser'); if(localStorage.getItem('ghRepo')) document.getElementById('ghRepo').value = localStorage.getItem('ghRepo'); }

        async function salvarNoGithub() {
            const t = document.getElementById('ghToken').value, u = document.getElementById('ghUser').value, r = document.getElementById('ghRepo').value;
            if(!t) return alert("Configure GitHub!");
            if(!confirm("Salvar DB?")) return;
            const conf = montarConfig();
            const dbMaster = {...conf}; delete dbMaster.cliente; delete dbMaster.fotos;
            const content = btoa(unescape(encodeURIComponent(`window.NBV_DB = ${JSON.stringify(dbMaster, null, 4)};`)));
            try {
                const url = `https://api.github.com/repos/${u}/${r}/contents/js/database.js`;
                const sha = (await (await fetch(url, {headers:{'Authorization':`token ${t}`}})).json()).sha;
                await fetch(url, {method:'PUT', headers:{'Authorization':`token ${t}`,'Content-Type':'application/json'}, body:JSON.stringify({message:"Admin Update", content:content, sha:sha})});
                alert("Sucesso!");
            } catch(e) { alert("Erro: "+e); }
        }
    </script>
</body>
</html>
