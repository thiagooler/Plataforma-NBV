<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Pedido Studio NBV</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* TEMA CLARO (LIGHT MODE) */
:root{
    --bg:#f8f9fa; --card:#ffffff; --text:#1f2937; --text-light:#6b7280;
    --primary:#0066cc; --primary-dark:#004c99; --success:#10b981; --danger:#ef4444; --warning:#f59e0b;
    --border:#e5e7eb;
}
* { box-sizing: border-box; }
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding-bottom:100px}
.container{max-width:600px;margin:0 auto;padding:20px}
.hidden{display:none !important}

/* CARDS & LAYOUT */
.card{background:var(--card);padding:20px;border-radius:12px;margin-bottom:15px;border:1px solid var(--border);box-shadow:0 2px 4px rgba(0,0,0,0.02)}
h2{margin-top:0;color:var(--primary-dark);text-align:center;font-size:1.5rem}
h3{margin:0 0 10px 0;font-size:1.1rem;color:var(--text)}
p{color:var(--text-light);line-height:1.5;margin-bottom:15px}
img{max-width:100%;border-radius:8px}

/* BOT√ïES */
.btn{background:var(--primary);color:#fff;border:none;padding:15px;width:100%;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;text-decoration:none;margin-top:10px;transition:0.2s}
.btn:active{transform:scale(0.98)}
.btn-success{background:var(--success)}
.btn-outline{background:transparent;border:2px solid var(--border);color:var(--text-light)}
.btn-outline:hover{border-color:var(--primary);color:var(--primary)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}

/* WORKSTATION */
.work-grid{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.photo-container{position:relative;background:#eee;min-height:300px;display:flex;align-items:center;justify-content:center;border-radius:8px;overflow:hidden;border:1px solid var(--border)}
.photo-container img{width:100%;pointer-events:none;user-select:none}

/* MARCA D'√ÅGUA */
.watermark-overlay {
    position: absolute; top:0; left:0; width:100%; height:100%;
    background-repeat: repeat; background-position: center; pointer-events: none; z-index: 10;
}

/* LISTA DE PRODUTOS */
.prod-item{padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.prod-item:last-child{border-bottom:none}
.prod-info{font-size:14px;font-weight:500}
.prod-price{font-size:12px;color:var(--text-light)}
.stepper{display:flex;gap:5px;align-items:center}
.stepper button{background:var(--border);border:none;color:var(--text);width:32px;height:32px;border-radius:6px;font-weight:bold;cursor:pointer}
.stepper span{width:25px;text-align:center;font-weight:bold}
.brinde-tag{background:var(--success);color:white;font-size:10px;padding:2px 6px;border-radius:4px;margin-left:5px}

/* MODAL & ALERTS */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:999;display:flex;align-items:center;justify-content:center;padding:20px}
.modal-box{background:white;padding:25px;border-radius:12px;max-width:400px;text-align:center}
.modal-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;max-height:60vh;overflow-y:auto}
.thumb-box{position:relative;aspect-ratio:1;overflow:hidden;border-radius:4px}
.thumb-box img{width:100%;height:100%;object-fit:cover}

/* Inputs */
input, select { width: 100%; padding: 12px; margin-top: 5px; background: #fff; border: 1px solid var(--border); color: var(--text); border-radius: 6px; }
</style>
</head>
<body>

<div id="app">
    <div style="text-align:center;padding:50px;color:#666"><i class="fas fa-spinner fa-spin"></i> Carregando Sistema...</div>
</div>

<script src="js/database.js"></script>
<script src="config_cliente.js"></script>

<script>
const App = {
    data: {},
    state: { view: 'intro', idx: 0, mode: 'avulso', sel: [], pag: 'pix', frete: 'sede', modalOpen: false },

    init() {
        if(!window.NBV_CONFIG) return document.getElementById('app').innerHTML = "Erro: Config n√£o encontrada. Gere o site novamente.";
        
        // Mesclagem de Dados
        this.data = { ...window.NBV_DB, ...window.NBV_CONFIG };
        this.data.financeiro = { ...window.NBV_DB.financeiro, ...window.NBV_CONFIG.financeiro };
        
        // Inicializa Sele√ß√£o
        this.state.sel = this.data.fotos.map(url => ({ inAlbum: false, isApproved: false, extras: {} }));
        
        // Decis√£o de Rota Inicial (Venda vs Aprova√ß√£o)
        if (this.data.fluxo.pedirEdicao) {
            this.state.view = 'intro';
        } else {
            // Modo Aprova√ß√£o Simples
            this.state.mode = 'aprovacao_simples';
            this.state.view = 'workstation';
        }
        
        this.render();
    },

    // --- RENDERIZADOR PRINCIPAL ---
    render() {
        const app = document.getElementById('app');
        const view = this.state.view;
        let html = '';

        // 1. TELA INTRO (EDI√á√ÉO)
        if(view === 'intro') {
            html = `
            <div class="container">
                <h2>Ol√°, ${this.data.cliente.nome}!</h2>
                <div class="card" style="text-align:center">
                    <p>Temos <strong>${this.data.fotos.length} fotos</strong> prontas.</p>
                    <button class="btn btn-outline" onclick="App.toggleModalFotos()">
                        <i class="fas fa-eye"></i> Espiar Fotos
                    </button>
                </div>
                
                <div class="card">
                    <p style="text-align:center;font-weight:600">Deseja edi√ß√£o nas fotos?</p>
                    <div class="grid-2">
                        <button class="btn btn-outline" style="flex-direction:column; padding:20px" onclick="App.escolherEdicao(false)">
                            <i class="fas fa-bolt" style="font-size:24px;color:var(--warning)"></i>
                            <span>N√£o Preciso</span>
                            <small style="font-size:11px;font-weight:400">Produ√ß√£o R√°pida (10 dias)</small>
                        </button>
                        <button class="btn btn-outline" style="flex-direction:column; padding:20px" onclick="App.escolherEdicao(true)">
                            <i class="fas fa-magic" style="font-size:24px;color:var(--primary)"></i>
                            <span>Quero Edi√ß√£o</span>
                            <small style="font-size:11px;font-weight:400">Tratamento Art√≠stico (30 dias)</small>
                        </button>
                    </div>
                </div>
            </div>`;
        }

        // 2. APRESENTA√á√ÉO (EDUCATIVO)
        else if(view === 'apresentacao') {
            const pres = this.data.apresentacao || {};
            html = `
            <div class="container fade-in">
                <h2>Conhe√ßa nossos Produtos</h2>
                <div class="card">
                    <img src="${pres.book?.img}" style="height:180px;object-fit:cover;width:100%">
                    <h3 style="margin-top:15px">üìö Fotolivros</h3>
                    <p>${pres.book?.text}</p>
                </div>
                <div class="card">
                    <img src="${pres.print?.img}" style="height:180px;object-fit:cover;width:100%">
                    <h3 style="margin-top:15px">üñºÔ∏è Revela√ß√µes</h3>
                    <p>${pres.print?.text}</p>
                </div>
                <button class="btn" onclick="App.irParaModo()">Entendi, quero escolher! ‚ûî</button>
            </div>`;
        }

        // 3. MODO DE PRODU√á√ÉO (FOTOLIVRO / REVELA√á√ÉO)
        else if(view === 'modo') {
            const qtdFotos = this.data.fotos.length;
            const minFotos = this.data.fluxo.minimoFotosLivro || 20;
            const temMinimo = qtdFotos >= minFotos;
            
            // C√°lculo pr√©vio do √Ålbum
            let albumCard = '';
            if(temMinimo) {
                // Encontra a melhor op√ß√£o de √°lbum para essa qtd
                const opcoes = this.calcularOpcoesAlbum(qtdFotos);
                let listaOpcoes = opcoes.map(op => `
                    <div style="background:#f1f5f9; padding:10px; border-radius:6px; margin-top:5px; font-size:13px; display:flex; justify-content:space-between">
                        <span><b>${op.nome}</b></span>
                        <span style="color:var(--primary)">12x ${formatMoney(op.parcela)}</span>
                    </div>
                `).join('');

                albumCard = `
                <div class="card" style="border:2px solid var(--primary)">
                    <h3>üìö Fazer Fotolivro</h3>
                    <p style="margin-bottom:10px">Ideal para suas ${qtdFotos} fotos.</p>
                    ${listaOpcoes}
                    <button class="btn" onclick="App.setMode('album')">Montar Fotolivro</button>
                </div>`;
            }

            html = `
            <div class="container fade-in">
                <h2>Como deseja produzir?</h2>
                ${albumCard}
                
                <div class="card">
                    <h3>üñºÔ∏è Fazer Revela√ß√£o</h3>
                    <p>Fotos avulsas, porta-retratos e quadros.</p>
                    <button class="btn btn-outline" onclick="App.setMode('avulso')">Escolher Revela√ß√µes</button>
                </div>

                <div style="text-align:center; margin-top:20px">
                    <a href="#" onclick="App.tentarDigitalOnly()" style="color:var(--text-light); font-size:13px; text-decoration:underline">Desejo todas somente em Arquivo</a>
                </div>
            </div>`;
        }

        // 4. WORKSTATION (SELE√á√ÉO)
        else if(view === 'workstation') {
            const foto = this.data.fotos[this.state.idx];
            const sel = this.state.sel[this.state.idx];
            
            // Gera Marca D'√°gua SVG
            const wmText = this.data.assets?.watermarkText || "NBV PROIBIDO PRINT";
            const wmOp = this.data.assets?.opacity || 0.2;
            const svg = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(`<svg width='300' height='150' xmlns='http://www.w3.org/2000/svg'><text x='50%' y='50%' transform='rotate(-20 150 75)' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-weight='bold' font-size='20' fill='%23000' fill-opacity='${wmOp}'>${wmText}</text></svg>`)}`;

            html = `
            <div class="container">
                <div class="work-grid">
                    <button class="btn-outline" onclick="App.nav(-1)" style="width:auto">‚ùÆ</button>
                    <span style="font-weight:bold">${this.state.idx + 1} / ${this.data.fotos.length}</span>
                    <button class="btn-outline" onclick="App.nav(1)" style="width:auto">‚ùØ</button>
                </div>
                
                <div class="photo-container">
                    <img src="${foto}" oncontextmenu="return false;">
                    <div class="watermark-overlay" style="background-image: url('${svg}')"></div>
                </div>

                ${this.state.mode === 'album' ? `
                <div class="card" style="margin-top:15px; padding:15px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; border:2px solid ${sel.inAlbum?'var(--success)':'var(--border)'}" onclick="App.toggleAlbum()">
                    <strong>üìö Incluir no √Ålbum</strong>
                    <i class="fas ${sel.inAlbum?'fa-check-circle':'fa-circle'}" style="font-size:24px; color:${sel.inAlbum?'var(--success)':'#ccc'}"></i>
                </div>` : ''}

                <div class="card" style="margin-top:15px">
                    <h3 style="font-size:1rem; color:var(--text-light)">Fazer Revela√ß√£o desta foto:</h3>
                    ${this.renderSmartProductList(sel)}
                </div>

                <button class="btn btn-success" onclick="App.checkout()">Finalizar Pedido ‚ûî</button>
            </div>`;
        }

        // 5. CHECKOUT
        else if(view === 'checkout') {
            const resumo = this.calcularTotal();
            html = `
            <div class="container">
                <h2>Resumo do Pedido</h2>
                <div class="card" style="font-family:monospace;font-size:13px;white-space:pre-wrap;background:#f1f5f9">${resumo.texto}</div>
                
                <div class="card">
                    <h3>üöö Frete / Entrega</h3>
                    <select id="frete" onchange="App.setFrete(this.value)">
                        <option value="sede">Retirar na Sede (S√≠tio Boa Ventura)</option>
                        <option value="gratis">Frete Gr√°tis (${this.data.logistica.cidadesGratis.join(', ')})</option>
                        <option value="transp">Transportadora (+ ${formatMoney(this.data.logistica.taxaEnvio)})</option>
                    </select>
                    ${this.state.frete !== 'sede' ? `<input type="text" id="endereco" placeholder="Endere√ßo de Entrega / Local na Cidade">` : ''}
                </div>

                <div class="card">
                    <h3>üí≥ Pagamento</h3>
                    <div style="display:flex;justify-content:space-between;font-size:18px;margin-bottom:10px;font-weight:bold;color:var(--success)">
                        <span>Total Final:</span>
                        <span>${formatMoney(resumo.total)}</span>
                    </div>
                    <select id="pag" onchange="App.setPag(this.value)">
                        <option value="pix">Pix (5% Desconto)</option>
                        <option value="cartao">Cart√£o de Cr√©dito</option>
                        <option value="boleto">Boleto (at√© 6x)</option>
                    </select>

                    ${this.state.pag === 'boleto' ? `
                    <div style="background:#eff6ff; padding:10px; border-radius:6px; margin-top:10px; border:1px solid #bfdbfe">
                        <label style="font-size:12px">Nome Completo</label><input type="text" id="bol_nome">
                        <label style="font-size:12px">CPF</label><input type="text" id="bol_cpf">
                        <label style="font-size:12px">Vencimento</label><input type="date" id="bol_data">
                    </div>` : ''}
                </div>

                <button class="btn btn-success" onclick="App.enviarZap()">Enviar Pedido no WhatsApp</button>
                <button class="btn btn-outline" onclick="App.setMode(App.state.mode)">Voltar e Editar</button>
            </div>`;
        }

        app.innerHTML = html;
        if(this.state.modalOpen) this.renderModalFotos();
    },

    // --- FUN√á√ïES DE INTERFACE ---

    // Lista Inteligente de Produtos
    renderSmartProductList(sel) {
        let html = '';
        const allProds = this.data.produtosAvulsos;
        
        // 1. Identifica se tem alguma revela√ß√£o selecionada
        const prints = allProds.filter(p => p.nome.toLowerCase().includes('foto') || p.nome.toLowerCase().includes('revel'));
        const frames = allProds.filter(p => p.nome.toLowerCase().includes('porta') || p.nome.toLowerCase().includes('moldura'));
        const digital = allProds.find(p => p.nome.toLowerCase().includes('digital'));

        const hasAnyPrint = Object.keys(sel.extras).some(k => k.toLowerCase().includes('foto'));

        // Renderiza Revela√ß√µes
        prints.forEach(p => {
            const qtd = sel.extras[p.nome] || 0;
            html += this.renderStepperItem(p, qtd);
            
            // Regra: Se tem revela√ß√£o X selecionada, mostra moldura X abaixo
            if (qtd > 0) {
                // Extrai dimens√£o (ex: 15x20)
                const dim = p.nome.match(/\d+x\d+/);
                if (dim) {
                    const frameMatch = frames.find(f => f.nome.includes(dim[0]));
                    if (frameMatch) {
                        const qtdFrame = sel.extras[frameMatch.nome] || 0;
                        html += `<div style="margin-left:20px; border-left:2px solid var(--border); padding-left:10px">
                            ${this.renderStepperItem(frameMatch, qtdFrame)}
                        </div>`;
                    }
                }
            }
        });

        // Renderiza Digital (Com Regra de Brinde)
        if (digital) {
            if (hasAnyPrint) {
                html += `
                <div class="prod-item" style="opacity:0.7">
                    <div class="prod-info">Arquivo Digital <span class="brinde-tag">BRINDE INCLUSO!</span></div>
                    <i class="fas fa-check" style="color:var(--success)"></i>
                </div>`;
                // Remove cobran√ßa se houver
                if (sel.extras[digital.nome]) delete sel.extras[digital.nome];
            } else {
                html += this.renderStepperItem(digital, sel.extras[digital.nome] || 0);
            }
        }

        return html;
    },

    renderStepperItem(p, qtd) {
        return `
        <div class="prod-item">
            <div>
                <div class="prod-info">${p.nome}</div>
                <div class="prod-price">${formatMoney(p.preco)}</div>
            </div>
            <div class="stepper">
                <button onclick="App.addProd('${p.nome}', -1)">-</button>
                <span>${qtd}</span>
                <button onclick="App.addProd('${p.nome}', 1)">+</button>
            </div>
        </div>`;
    },

    // --- MODAL ESPIAR FOTOS ---
    toggleModalFotos() {
        const modal = document.getElementById('modal-fotos');
        if(modal) { modal.remove(); return; }
        
        // Gera Marca D'√°gua para Thumb
        const wmText = this.data.assets?.watermarkText || "NBV";
        const svg = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(`<svg width='150' height='150' xmlns='http://www.w3.org/2000/svg'><text x='50%' y='50%' transform='rotate(-45 75 75)' text-anchor='middle' font-family='Arial' font-weight='bold' font-size='16' fill='%23000' fill-opacity='0.3'>${wmText}</text></svg>`)}`;

        const gridHtml = this.data.fotos.map(url => `
            <div class="thumb-box">
                <img src="${url}">
                <div class="watermark-overlay" style="background-image:url('${svg}')"></div>
            </div>
        `).join('');

        const html = `
        <div id="modal-fotos" class="modal-overlay" onclick="if(event.target===this) this.remove()">
            <div class="modal-box">
                <h3>Suas Fotos (${this.data.fotos.length})</h3>
                <div class="modal-grid">${gridHtml}</div>
                <button class="btn btn-outline" style="margin-top:15px" onclick="document.getElementById('modal-fotos').remove()">Fechar</button>
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
    },

    // --- L√ìGICA DE NEG√ìCIO ---
    calcularOpcoesAlbum(qtd) {
        // Encontra os tamanhos dispon√≠veis que comportam a qtd
        const tamanhos = [...new Set(this.data.tabelaFotolivros.map(t => t.size))];
        const markup = this.data.financeiro.markup;
        const fixo = this.data.financeiro.custoFixoDiagramacao;
        const opcoes = [];

        tamanhos.forEach(tam => {
            // Regra p√°gina
            const fotosPorPag = this.data.regrasDiagramacao[tam] || 4;
            const pagsNecessarias = Math.ceil(qtd / fotosPorPag);
            
            // Busca na tabela
            const listaTam = this.data.tabelaFotolivros.filter(t => t.size === tam).sort((a,b)=>a.pages-b.pages);
            const match = listaTam.find(t => t.pages >= pagsNecessarias);
            
            if(match) {
                const precoVenda = (match.price + fixo) * markup; // Pre√ßo sem caixa (exemplo)
                const parcela = (precoVenda * 1.21) / 12; // Juros de 21% em 12x (Exemplo do DB)
                opcoes.push({ nome: `Fotolivro ${tam} (${match.pages} p√°gs)`, total: precoVenda, parcela: parcela });
            }
        });
        return opcoes;
    },

    tentarDigitalOnly() {
        if(confirm("‚ö†Ô∏è TEM CERTEZA?\n\nAs fotos em Arquivo Digital custam R$ 8,00.\nAs fotos Reveladas 10x15 custam R$ 10,00 e voc√™ GANHA o arquivo digital de brinde!\n\nVale muito mais a pena revelar.\n\nDeseja mesmo continuar apenas com arquivos?")) {
            this.setMode('avulso'); // Mas o usu√°rio ter√° que selecionar manualmente
            alert("Ok. Selecione 'Arquivo Digital' na lista.");
        }
    },

    // --- FUN√á√ïES DE NAVEGA√á√ÉO E STATE ---
    escolherEdicao(quer) {
        if(quer) window.location.href = `https://wa.me/${this.data.financeiro.whatsapp}?text=Gostaria de Edicao Artistica.`;
        else { this.state.view = 'apresentacao'; this.render(); }
    },
    irParaModo() { this.state.view = 'modo'; this.render(); },
    setMode(m) { this.state.mode = m; this.state.view = 'workstation'; this.render(); },
    nav(d) { this.state.idx = (this.state.idx + d + this.data.fotos.length) % this.data.fotos.length; this.render(); },
    toggleAlbum() { this.state.sel[this.state.idx].inAlbum = !this.state.sel[this.state.idx].inAlbum; this.render(); },
    addProd(nome, d) {
        const curr = this.state.sel[this.state.idx].extras[nome] || 0;
        const novo = Math.max(0, curr + d);
        if(novo === 0) delete this.state.sel[this.state.idx].extras[nome];
        else this.state.sel[this.state.idx].extras[nome] = novo;
        this.render();
    },
    checkout() { this.state.view = 'checkout'; this.render(); },
    setFrete(v) { this.state.frete = v; this.render(); },
    setPag(v) { this.state.pag = v; this.render(); },

    // --- C√ÅLCULO FINAL ---
    calcularTotal() {
        let total = 0;
        let texto = "";
        
        // 1. Fotolivro
        if(this.state.mode === 'album') {
            const qtd = this.state.sel.filter(s=>s.inAlbum).length;
            // (L√≥gica simplificada para demo - em produ√ß√£o usaria a tabela completa de match)
            if(qtd > 0) {
                texto += `üìö Fotolivro Sele√ß√£o: ${qtd} fotos\n(Valor ser√° calculado na confer√™ncia)\n`;
            }
        }

        // 2. Avulsos
        this.state.sel.forEach(s => {
            Object.keys(s.extras).forEach(k => {
                // Pula se for Digital Brinde (l√≥gica de valida√ß√£o)
                const hasPrint = Object.keys(s.extras).some(x => x.includes('Foto'));
                if (k.includes('Digital') && hasPrint) return;

                const p = this.data.produtosAvulsos.find(x=>x.nome===k);
                if(p) {
                    const sub = p.preco * s.extras[k];
                    total += sub;
                    texto += `üñºÔ∏è ${s.extras[k]}x ${k}: ${formatMoney(sub)}\n`;
                }
            });
        });

        // 3. Frete
        if(this.state.frete === 'transp') {
            total += this.data.logistica.taxaEnvio;
            texto += `üöö Frete: ${formatMoney(this.data.logistica.taxaEnvio)}\n`;
        }

        // 4. Entrada
        const entrada = this.data.cliente.entrada || 0;
        if(entrada > 0) {
            total -= entrada;
            texto += `üí∞ Entrada Paga: - ${formatMoney(entrada)}\n`;
        }
        
        if(total < 0) total = 0;
        return { total, texto };
    },

    enviarZap() {
        const calc = this.calcularTotal();
        let msg = `*PEDIDO - ${this.data.cliente.nome}*\n\n${calc.texto}\n`;
        msg += `-------------------\n*TOTAL A PAGAR: ${formatMoney(calc.total)}*\n`;
        msg += `Pagamento: ${this.state.pag.toUpperCase()}\n`;
        
        if(this.state.pag === 'boleto') {
            const nome = document.getElementById('bol_nome').value;
            const cpf = document.getElementById('bol_cpf').value;
            const data = document.getElementById('bol_data').value;
            msg += `Boleto: ${nome}, CPF ${cpf}, Venc ${data}\n`;
        }

        if(this.state.frete !== 'sede') {
            const end = document.getElementById('endereco') ? document.getElementById('endereco').value : 'Frete Gr√°tis na Cidade';
            msg += `üìç Entrega: ${end}\n`;
        } else {
            msg += `üìç Retirada na Sede\n`;
        }

        window.open(`https://wa.me/${this.data.financeiro.whatsapp}?text=${encodeURIComponent(msg)}`);
    }
};

function formatMoney(v) { return v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); }
window.onload = () => App.init();
</script>
</body>
</html>
