<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Pedido Studio NBV</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* TEMA CLARO (LIGHT MODE) - BASE */
:root{
    --bg:#f8f9fa; --card:#ffffff; --text:#1f2937; --text-light:#6b7280;
    --primary:#007bff; /* AZUL PADR√ÉO */
    --primary-dark:#0056b3; 
    --success:#28a745; --danger:#dc3545; --warning:#ffc107;
    --border:#dee2e6;
}
* { box-sizing: border-box; }
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding-bottom:100px}
.container{max-width:800px;margin:0 auto;padding:20px}
.hidden{display:none !important}

/* CARDS & LAYOUT */
.card{background:var(--card);padding:20px;border-radius:12px;margin-bottom:15px;border:1px solid var(--border);box-shadow:0 4px 6px rgba(0,0,0,0.05); position: relative;}
h2{margin-top:0;color:var(--text);text-align:center;font-size:1.6rem; margin-bottom: 20px;}
h3{margin:0 0 10px 0;font-size:1.2rem;color:var(--text); font-weight: 700;}
p{color:var(--text-light);line-height:1.6;margin-bottom:15px}
img{max-width:100%;border-radius:8px}

/* PRE√áOS EM DESTAQUE */
.price-highlight { font-size: 1.3rem; color: var(--primary); font-weight: bold; margin: 10px 0; }
.installment-highlight { font-size: 0.9rem; color: #666; font-weight: 600; margin-bottom: 15px; display: block;}

/* BOT√ïES */
.btn{background:var(--primary);color:#fff;border:none;padding:14px;width:100%;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;text-decoration:none;margin-top:10px;transition:0.2s}
.btn:active{transform:scale(0.98)}
.btn:hover{background:var(--primary-dark)}

.btn-success{background:var(--success)}
.btn-success:hover{background:#218838}

.btn-secondary{background:#6c757d}
.btn-secondary:hover{background:#5a6268}

.btn-outline{background:transparent;border:2px solid var(--primary);color:var(--primary)}
.btn-outline:hover{background:#eef7ff}

.btn-link { background: none; color: var(--text-light); border: none; padding: 10px; font-size: 0.9rem; text-decoration: underline; margin-top: 5px; cursor: pointer;}

.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:15px}

/* WORKSTATION (CARROSSEL) */
.work-grid{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.photo-container{position:relative;background:#eee;min-height:300px;display:flex;align-items:center;justify-content:center;border-radius:8px;overflow:hidden;border:1px solid var(--border); margin-bottom: 20px;}
.photo-container img{width:100%;pointer-events:none;user-select:none; display: block;}

/* MARCA D'√ÅGUA */
.watermark-overlay {
    position: absolute; top:0; left:0; width:100%; height:100%;
    background-repeat: repeat; background-position: center; pointer-events: none; z-index: 10;
}

/* LISTA DE PRODUTOS INTELIGENTE */
.prod-item{padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.prod-item:last-child{border-bottom:none}
.prod-info{font-size:14px;font-weight:600}
.prod-price{font-size:12px;color:var(--text-light)}
.stepper{display:flex;gap:5px;align-items:center}
.stepper button{background:#e9ecef;border:none;color:var(--text);width:32px;height:32px;border-radius:6px;font-weight:bold;cursor:pointer}
.stepper span{width:25px;text-align:center;font-weight:bold}

/* MODAL ESPIAR (GALLERY) */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:999;display:flex;align-items:center;justify-content:center;padding:20px}
.modal-box{background:white;padding:20px;border-radius:12px;max-width:500px;width:100%; max-height: 80vh; display: flex; flex-direction: column;}
.modal-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(100px, 1fr)); gap:5px; overflow-y:auto; padding: 5px;}
.thumb-box{position:relative;aspect-ratio:1;overflow:hidden;border-radius:4px; cursor: pointer;}
.thumb-box img{width:100%;height:100%;object-fit:cover; transition: transform 0.2s;}
.thumb-box:hover img { transform: scale(1.1); }

/* LIGHTBOX (FOTO GRANDE) */
.lightbox-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.95); z-index: 2000;
    display: flex; align-items: center; justify-content: center;
}
.lightbox-img { max-width: 95%; max-height: 90%; border: 2px solid white; border-radius: 4px; }
.lightbox-close { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; cursor: pointer; z-index: 2001;}

/* INPUTS */
input, select { width: 100%; padding: 12px; margin-top: 5px; background: #fff; border: 1px solid var(--border); color: var(--text); border-radius: 6px; }

/* ANIMA√á√ÉO PULSE (PERSUAS√ÉO) */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}
.pulse-btn { animation: pulse 2s infinite; }
</style>
</head>
<body>

<div id="app">
    <div style="text-align:center;padding:50px;color:#666"><i class="fas fa-spinner fa-spin"></i> Carregando Sistema...</div>
</div>

<script>
    // Configura√ß√£o simulada (substituiria os scripts externos)
    window.NBV_CONFIG = {
        cliente: { nome: "Warrior", entrada: 0 },
        fluxo: { pedirEdicao: true, minimoFotosLivro: 15 },
        assets: { watermarkText: "NBV PROVA", opacity: 0.3 }
    };
    window.NBV_DB = {
        fotos: [
            "https://via.placeholder.com/800x600/ccc/333?text=Foto+01",
            "https://via.placeholder.com/800x600/ccc/333?text=Foto+02",
            "https://via.placeholder.com/600x800/ccc/333?text=Foto+03+(Vertical)",
            "https://via.placeholder.com/800x600/ccc/333?text=Foto+04",
            "https://via.placeholder.com/800x600/ccc/333?text=Foto+05"
        ],
        financeiro: { markup: 2.5, custoFixoDiagramacao: 100, whatsapp: "5542999999999" },
        tabelaFotolivros: [
            { size: "20x20", pages: 20, price: 200 }, // Pre√ßo custo base
            { size: "25x25", pages: 20, price: 300 }
        ],
        regrasDiagramacao: { "20x20": 4, "25x25": 5 },
        produtosAvulsos: [
            { nome: "Revela√ß√£o 10x15", preco: 10.00 },
            { nome: "Revela√ß√£o 15x21", preco: 20.00 },
            { nome: "Arquivo Digital (un)", preco: 8.00 },
            { nome: "Porta Retrato 10x15", preco: 45.00 }, // Frame para 10x15
            { nome: "Moldura 15x21", preco: 65.00 }        // Frame para 15x21
        ],
        logistica: { taxaEnvio: 30, cidadesGratis: ["Boa Ventura", "Turvo"] },
        apresentacao: {
            book: { text: "O Fotolivro Premium possui abertura 180¬∫, capa dura fotogr√°fica e papel de alta gramatura que n√£o amarela.", img: "https://via.placeholder.com/400x200?text=Foto+Livro" },
            print: { text: "Papel Profissional Fuji Crystal com durabilidade de 100 anos. Cores fi√©is e vivas.", img: "https://via.placeholder.com/400x200?text=Revelacao" },
            digital: { text: "Receba o link para download das fotos em alta resolu√ß√£o.", img: "https://via.placeholder.com/400x200?text=Digital" }
        }
    };
</script>

<script>
const App = {
    data: {},
    state: { view: 'intro', idx: 0, mode: '', sel: [], pag: 'pix', frete: 'sede', modalOpen: false, lightboxUrl: null },

    init() {
        if(!window.NBV_CONFIG) return document.getElementById('app').innerHTML = "Erro: Config n√£o encontrada.";
        
        // Mesclagem de Dados
        this.data = { ...window.NBV_DB, ...window.NBV_CONFIG };
        
        // Inicializa Sele√ß√£o
        this.state.sel = this.data.fotos.map(url => ({ inAlbum: false, isApproved: false, extras: {} }));
        
        this.render();
    },

    // --- RENDERIZADOR PRINCIPAL ---
    render() {
        const app = document.getElementById('app');
        const view = this.state.view;
        let html = '';

        // 1. TELA INTRO (Boas Vindas)
        if(view === 'intro') {
            html = `
            <div class="container">
                <h2>Ol√°, ${this.data.cliente.nome}!</h2>
                <div class="card" style="text-align:center">
                    <p>Temos <strong>${this.data.fotos.length} fotos</strong> incr√≠veis prontas para voc√™.</p>
                    <button class="btn btn-outline" onclick="App.toggleModalFotos()">
                        <i class="fas fa-th"></i> Espiar Todas as Fotos
                    </button>
                </div>
                
                <div class="card">
                    <p style="text-align:center;font-weight:600">Como prefere seguir?</p>
                    <button class="btn btn-primary" onclick="App.irParaModo()">
                        Iniciar Sele√ß√£o dos Produtos ‚ûî
                    </button>
                    </div>
            </div>`;
        }

        // 2. MODO DE PRODU√á√ÉO (MENU PRINCIPAL)
        else if(view === 'modo') {
            const qtdFotos = this.data.fotos.length;
            
            // --- L√≥gica de Pre√ßo do Fotolivro ---
            // Pega o primeiro album vi√°vel para mostrar pre√ßo "A partir de" ou exato
            const opcoesAlbum = this.calcularOpcoesAlbum(qtdFotos);
            let precoAlbum = "Sob Consulta";
            let parcelaAlbum = "";
            
            if(opcoesAlbum.length > 0) {
                precoAlbum = formatMoney(opcoesAlbum[0].total);
                parcelaAlbum = `ou 12x de ${formatMoney(opcoesAlbum[0].parcela)}`;
            }

            html = `
            <div class="container">
                <h2>Como deseja produzir?</h2>
                
                <div class="card" style="border: 2px solid var(--primary);">
                    <div style="position:absolute; top:-12px; right:20px; background:var(--primary); color:white; padding:4px 10px; font-size:12px; border-radius:4px; font-weight:bold;">RECOMENDADO</div>
                    <h3>üìö Fotolivro Premium</h3>
                    <p>A melhor forma de guardar sua hist√≥ria.</p>
                    
                    <div class="price-highlight">${precoAlbum}</div>
                    <span class="installment-highlight">${parcelaAlbum}</span>
                    
                    <button class="btn btn-primary" onclick="App.setMode('album')">Montar Fotolivro</button>
                    <button class="btn-link" onclick="App.verDetalhes('book')">Ver Detalhes do Acabamento</button>
                </div>
                
                <div class="card">
                    <h3>üñºÔ∏è Fazer Revela√ß√£o</h3>
                    <p>Fotos avulsas em papel profissional.</p>
                    <button class="btn btn-primary" onclick="App.setMode('avulso')">Selecionar para Revela√ß√£o</button>
                    <button class="btn-link" onclick="App.verDetalhes('print')">Ver Detalhes do Papel</button>
                </div>

                <div class="card">
                    <h3>üíæ Somente Arquivo</h3>
                    <p>Download das fotos em alta resolu√ß√£o.</p>
                    <button class="btn btn-primary" onclick="App.irParaPersuasao()">Quero os Arquivos</button>
                    <button class="btn-link" onclick="App.verDetalhes('digital')">Como funciona?</button>
                </div>

                <div style="text-align:center; margin-top: 20px;">
                    <button class="btn-outline" onclick="App.toggleModalFotos()" style="width:auto; display:inline-flex;">
                         üì∏ Espiar Fotos Novamente
                    </button>
                </div>
            </div>`;
        }

        // 3. P√ÅGINA DE DETALHES (Informativa)
        else if(view === 'detalhes') {
            const tipo = this.state.detalheTipo; // book, print, digital
            const info = this.data.apresentacao[tipo];
            
            html = `
            <div class="container">
                <button class="btn-secondary" onclick="App.irParaModo()" style="width:auto; margin-bottom:15px; padding: 8px 15px;">‚Üê Voltar</button>
                <div class="card">
                    <img src="${info.img}" style="width:100%; height:200px; object-fit:cover; margin-bottom:15px;">
                    <h3>Detalhes</h3>
                    <p style="font-size:1.1rem; color:#333;">${info.text}</p>
                    
                    ${tipo === 'book' ? `<div style="background:#f8f9fa; padding:15px; border-left:4px solid var(--primary); margin:15px 0;"><strong>Vantagem:</strong> Diagrama√ß√£o inclusa e Durabilidade vital√≠cia.</div>` : ''}
                    
                    ${tipo === 'print' ? `<div style="background:#f8f9fa; padding:15px; border-left:4px solid var(--primary); margin:15px 0;"><strong>Obs:</strong> Entraremos em contato para confirmar acabamento Fosco ou Brilho.</div>` : ''}

                    <button class="btn btn-primary" onclick="App.acaoDoDetalhe('${tipo}')">
                        ${tipo === 'book' ? 'Montar Fotolivro Agora' : (tipo === 'print' ? 'Selecionar Fotos' : 'Entendi')}
                    </button>
                </div>
            </div>`;
        }

        // 4. P√ÅGINA DE PERSUAS√ÉO (Anti-Digital)
        else if(view === 'persuasao') {
            html = `
            <div class="container">
                <button class="btn-secondary" onclick="App.irParaModo()" style="width:auto; margin-bottom:15px; padding: 8px 15px;">‚Üê Voltar</button>
                
                <div class="card" style="border: 2px solid var(--warning); background: #fffdf5;">
                    <h2 style="color: #d97706;">‚ö†Ô∏è Espere um pouco!</h2>
                    <p>Arquivos digitais se perdem em HDs ou nuvens esquecidas. Voc√™ tem certeza que n√£o quer ter essas mem√≥rias em m√£os?</p>
                    
                    <ul style="text-align:left; color:#555; margin-bottom:20px;">
                        <li style="margin-bottom:10px;">‚úÖ <strong>Durabilidade:</strong> Papel fotogr√°fico dura gera√ß√µes.</li>
                        <li style="margin-bottom:10px;">‚úÖ <strong>Cores Reais:</strong> Telas de celular mentem a cor.</li>
                        <li style="margin-bottom:10px;">‚úÖ <strong>Ganhe o Digital:</strong> Ao revelar, voc√™ ganha o arquivo de brinde!</li>
                    </ul>

                    <button class="btn btn-primary pulse-btn" onclick="App.setMode('avulso')">
                        ‚ú® Quero Fazer Revela√ß√£o (Recomendado)
                    </button>
                    
                    <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                        <p style="font-size: 0.9rem;">Ainda prefiro arriscar e ficar s√≥ com os arquivos...</p>
                        <button class="btn btn-secondary" style="background:#ccc; color:#333;" onclick="App.checkoutDigital()">
                            Continuar somente com Arquivos
                        </button>
                    </div>
                </div>
            </div>`;
        }

        // 5. WORKSTATION (CARROSSEL DE SELE√á√ÉO)
        else if(view === 'workstation') {
            const foto = this.data.fotos[this.state.idx];
            const sel = this.state.sel[this.state.idx];
            const totalFotos = this.data.fotos.length;
            const idx = this.state.idx;
            
            // Marca d'√°gua
            const wmText = this.data.assets?.watermarkText || "NBV";
            const svg = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(`<svg width='300' height='150' xmlns='http://www.w3.org/2000/svg'><text x='50%' y='50%' transform='rotate(-20 150 75)' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-weight='bold' font-size='20' fill='%23000' fill-opacity='0.2'>${wmText}</text></svg>`)}`;

            html = `
            <div class="container">
                <button class="btn-secondary" onclick="App.irParaModo()" style="width:auto; margin-bottom:10px; padding: 5px 10px; font-size:0.8rem;">‚úñ Cancelar</button>
                
                <div class="photo-container">
                    <img src="${foto}" oncontextmenu="return false;">
                    <div class="watermark-overlay" style="background-image: url('${svg}')"></div>
                </div>

                ${this.state.mode === 'album' ? `
                <div class="card" style="padding:15px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; border:2px solid ${sel.inAlbum?'var(--success)':'var(--border)'}; transition:0.2s;" onclick="App.toggleAlbum()">
                    <div>
                        <strong>üìö Incluir no √Ålbum</strong>
                        <div style="font-size:12px; color:#666">${sel.inAlbum ? 'Selecionada' : 'Toque para selecionar'}</div>
                    </div>
                    <i class="fas ${sel.inAlbum?'fa-check-circle':'fa-circle'}" style="font-size:28px; color:${sel.inAlbum?'var(--success)':'#ccc'}"></i>
                </div>` : ''}

                <div class="card">
                    <h3 style="font-size:1rem; color:var(--text-light)">Revelar esta foto:</h3>
                    ${this.renderSmartProductList(sel)}
                </div>

                <div class="grid-2" style="margin-top:20px;">
                    ${idx > 0 ? 
                        `<button class="btn btn-secondary" onclick="App.nav(-1)">‚ùÆ Anterior</button>` : 
                        `<div style="visibility:hidden"></div>` // Espa√ßo vazio para manter layout
                    }

                    ${idx < totalFotos - 1 ? 
                        `<button class="btn btn-primary" onclick="App.nav(1)">Pr√≥xima ‚ùØ</button>` : 
                        `<button class="btn btn-success" onclick="App.checkout()">Finalizar Pedido ‚úì</button>`
                    }
                </div>
                
                <div style="text-align:center; margin-top:10px; font-size:12px; color:#999;">
                    Foto ${idx + 1} de ${totalFotos}
                </div>
            </div>`;
        }

        // 6. CHECKOUT (RESUMO)
        else if(view === 'checkout') {
            const resumo = this.calcularTotal();
            html = `
            <div class="container">
                <h2>Resumo do Pedido</h2>
                <div class="card" style="font-family:monospace;font-size:13px;white-space:pre-wrap;background:#f8f9fa; border-left: 4px solid var(--success);">${resumo.texto}</div>
                
                <div class="card">
                    <h3>üöö Entrega</h3>
                    <select id="frete" onchange="App.setFrete(this.value)">
                        <option value="sede">Retirar na Sede (S√≠tio Boa Ventura)</option>
                        <option value="gratis">Frete Gr√°tis (${this.data.logistica.cidadesGratis.join(', ')})</option>
                        <option value="transp">Transportadora (+ ${formatMoney(this.data.logistica.taxaEnvio)})</option>
                    </select>
                    ${this.state.frete !== 'sede' ? `<input type="text" id="endereco" placeholder="Digite seu Endere√ßo / Local">` : ''}
                </div>

                <div class="card">
                    <h3>üí≥ Pagamento</h3>
                    <div style="display:flex;justify-content:space-between;font-size:1.4rem;margin-bottom:15px;font-weight:bold;color:var(--success); border-bottom:1px dashed #ccc; padding-bottom:10px;">
                        <span>Total:</span>
                        <span>${formatMoney(resumo.total)}</span>
                    </div>
                    
                    <select id="pag" onchange="App.setPag(this.value)">
                        <option value="pix">Pix (5% Desconto)</option>
                        <option value="cartao">Cart√£o de Cr√©dito</option>
                        <option value="boleto">Boleto Parcelado</option>
                    </select>

                    ${this.state.pag === 'boleto' ? `
                    <div style="background:#eff6ff; padding:10px; border-radius:6px; margin-top:10px; border:1px solid #bfdbfe">
                        <input type="text" id="bol_nome" placeholder="Nome Completo">
                        <input type="text" id="bol_cpf" placeholder="CPF">
                    </div>` : ''}
                </div>

                <button class="btn btn-success" onclick="App.enviarZap()">
                    <i class="fab fa-whatsapp"></i> Enviar Pedido no WhatsApp
                </button>
                <button class="btn btn-outline" onclick="App.irParaModo()" style="margin-top:15px;">Voltar ao In√≠cio</button>
            </div>`;
        }

        app.innerHTML = html;
        
        // Renderiza Modais se necess√°rio
        if(this.state.modalOpen) this.renderModalFotos();
        if(this.state.lightboxUrl) this.renderLightbox();
    },

    // --- RENDERIZADORES AUXILIARES ---

    renderSmartProductList(sel) {
        let html = '';
        const allProds = this.data.produtosAvulsos;
        
        // Separa tipos
        const prints = allProds.filter(p => p.nome.toLowerCase().includes('foto') || p.nome.toLowerCase().includes('revel'));
        const frames = allProds.filter(p => p.nome.toLowerCase().includes('porta') || p.nome.toLowerCase().includes('moldura'));
        const digital = allProds.find(p => p.nome.toLowerCase().includes('digital'));

        const hasAnyPrint = Object.keys(sel.extras).some(k => k.toLowerCase().includes('foto') || k.toLowerCase().includes('revel'));

        // Renderiza Op√ß√µes de Revela√ß√£o
        prints.forEach(p => {
            const qtd = sel.extras[p.nome] || 0;
            html += this.renderStepperItem(p, qtd);
            
            // Se tiver revela√ß√£o X, mostra moldura compat√≠vel abaixo
            if (qtd > 0) {
                const dim = p.nome.match(/\d+x\d+/);
                if (dim) {
                    const frameMatch = frames.find(f => f.nome.includes(dim[0]));
                    if (frameMatch) {
                        const qtdFrame = sel.extras[frameMatch.nome] || 0;
                        html += `<div style="margin-left:20px; border-left:2px solid var(--border); padding-left:10px; margin-bottom:10px; background:#fafafa;">
                            <div style="font-size:11px; color:#666; margin-bottom:5px;">Deseja moldura para esta foto?</div>
                            ${this.renderStepperItem(frameMatch, qtdFrame)}
                        </div>`;
                    }
                }
            }
        });

        // L√≥gica do Arquivo Digital (Brinde ou Venda)
        // S√≥ mostra a op√ß√£o digital se N√ÉO estiver no modo 'album' (quem faz √°lbum j√° ganha digital geralmente, ou configura aqui)
        if (digital) {
            if (hasAnyPrint) {
                // Se revelou, ganha brinde
                html += `
                <div class="prod-item" style="opacity:0.7; background:#e8f5e9;">
                    <div class="prod-info">Arquivo Digital <span style="background:var(--success); color:white; font-size:10px; padding:2px 4px; border-radius:3px;">BRINDE!</span></div>
                    <i class="fas fa-check" style="color:var(--success)"></i>
                </div>`;
                // Garante que n√£o est√° cobrando
                if (sel.extras[digital.nome]) delete sel.extras[digital.nome];
            } else {
                // Se n√£o revelou, pode comprar avulso
                html += this.renderStepperItem(digital, sel.extras[digital.nome] || 0);
            }
        }

        return html;
    },

    renderStepperItem(p, qtd) {
        return `
        <div class="prod-item">
            <div>
                <div class="prod-info">${p.nome}</div>
                <div class="prod-price">${formatMoney(p.preco)}</div>
            </div>
            <div class="stepper">
                <button onclick="App.addProd('${p.nome}', -1)">-</button>
                <span>${qtd}</span>
                <button onclick="App.addProd('${p.nome}', 1)" style="background:var(--primary); color:white;">+</button>
            </div>
        </div>`;
    },

    // --- MODAL ESPIAR (GALLERY) ---
    toggleModalFotos() {
        this.state.modalOpen = !this.state.modalOpen;
        this.render();
    },
    
    renderModalFotos() {
        // Gera Marca D'√°gua para Thumb
        const wmText = this.data.assets?.watermarkText || "NBV";
        const svg = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(`<svg width='150' height='150' xmlns='http://www.w3.org/2000/svg'><text x='50%' y='50%' transform='rotate(-45 75 75)' text-anchor='middle' font-family='Arial' font-weight='bold' font-size='16' fill='%23000' fill-opacity='0.3'>${wmText}</text></svg>`)}`;

        const gridHtml = this.data.fotos.map(url => `
            <div class="thumb-box" onclick="App.openLightbox('${url}')">
                <img src="${url}">
                <div class="watermark-overlay" style="background-image:url('${svg}')"></div>
            </div>
        `).join('');

        const html = `
        <div id="modal-fotos" class="modal-overlay" onclick="if(event.target===this) App.toggleModalFotos()">
            <div class="modal-box">
                <h3>Todas as Fotos (${this.data.fotos.length})</h3>
                <p style="font-size:12px; color:#666">Clique na foto para ampliar.</p>
                <div class="modal-grid">${gridHtml}</div>
                <button class="btn btn-outline" style="margin-top:15px" onclick="App.toggleModalFotos()">Fechar Galeria</button>
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
    },

    // --- LIGHTBOX (ZOOM) ---
    openLightbox(url) {
        this.state.lightboxUrl = url;
        this.render(); // Re-renderiza para mostrar o lightbox
    },
    closeLightbox() {
        this.state.lightboxUrl = null;
        this.render();
    },
    renderLightbox() {
        const wmText = "PROVA - N√ÉO COPIAR"; // Texto mais forte no zoom
        const svg = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(`<svg width='400' height='200' xmlns='http://www.w3.org/2000/svg'><text x='50%' y='50%' transform='rotate(-15 200 100)' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-weight='bold' font-size='30' fill='%23ffffff' fill-opacity='0.4'>${wmText}</text></svg>`)}`;

        const html = `
        <div class="lightbox-overlay" onclick="if(event.target===this) App.closeLightbox()">
            <div class="lightbox-close" onclick="App.closeLightbox()">&times;</div>
            <div style="position:relative; display:inline-block">
                <img src="${this.state.lightboxUrl}" class="lightbox-img">
                <div class="watermark-overlay" style="background-image:url('${svg}'); position:absolute; top:0; left:0; width:100%; height:100%;"></div>
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
    },

    // --- L√ìGICA DE NAVEGA√á√ÉO E STATES ---
    irParaModo() { 
        this.state.view = 'modo'; 
        this.state.modalOpen = false; // Garante fechar modal
        this.render(); 
    },
    
    setMode(m) { 
        this.state.mode = m; 
        this.state.view = 'workstation'; 
        this.state.idx = 0; //
